<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Research - AI Training Suite</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'], mono: ['Fira Code', 'monospace'] },
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-main: #f8fafc;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --accent-color: #0284c7;
        }

        [data-theme="dark"] {
            --bg-main: #020617;
            --bg-panel: rgba(15, 23, 42, 0.6);
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-color: #0ea5e9;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main);
            transition: background-color 0.5s, color 0.5s;
        }
        
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            transition: background 0.5s, border 0.5s;
        }

        .animate-float { animation: float 8s ease-in-out infinite; }
        @keyframes float {
            0% { transform: translate(0, 0px); }
            50% { transform: translate(0, -20px); }
            100% { transform: translate(0, 0px); }
        }

        .scroller {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-ready { background-color: #94a3b8; }
        .status-working { background-color: #fbbf24; box-shadow: 0 0 8px #fbbf24; animation: pulse 1s infinite; }
        .status-active { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dead { background-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden selection:bg-cyan-500 selection:text-white" data-theme="light">

    <!-- Ambient Background -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[120px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-cyan-600/10 rounded-full blur-[120px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <!-- Navbar -->
    <nav class="relative z-50 px-6 py-4 border-b border-[var(--border-color)] glass-panel flex flex-col md:flex-row justify-between items-center sticky top-0 gap-4 md:gap-0">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <a href="index.html" class="p-2.5 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl shadow-lg shadow-cyan-500/20">
                <i data-lucide="brain-circuit" class="w-6 h-6 text-white"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    Text Research
                </h1>
                <div class="flex items-center gap-2">
                    <p class="text-[10px] opacity-60 uppercase tracking-widest font-semibold">Jarunyoo Thonganek</p>
                    <span class="w-1 h-1 bg-current rounded-full opacity-50"></span>
                    <p class="text-[10px] text-cyan-500">‡∏ô‡∏≤‡∏¢‡∏à‡∏£‡∏±‡∏ç‡∏ç‡∏π ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡∏Å</p>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap justify-center items-center gap-4">
             <button onclick="toggleAPIModal()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800/10 border border-[var(--border-color)] rounded-lg text-xs font-bold hover:bg-slate-800/20 transition-all text-[var(--text-main)]" title="Check API Status">
                <i data-lucide="activity" class="w-4 h-4 text-green-500"></i>
                <span class="hidden lg:inline">API Status</span>
            </button>

            <div class="flex bg-[var(--bg-main)] rounded-lg p-1 border border-[var(--border-color)]">
                <button onclick="setTheme('dark')" class="p-1.5 rounded hover:bg-slate-800 hover:text-white text-[var(--text-muted)]" title="Dark Mode"><i data-lucide="moon" class="w-4 h-4"></i></button>
                <button onclick="setTheme('light')" class="p-1.5 rounded hover:bg-slate-200 hover:text-black text-[var(--text-muted)]" title="Light Mode"><i data-lucide="sun" class="w-4 h-4"></i></button>
            </div>

            <a href="index.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs md:text-sm font-semibold transition-all flex items-center gap-2">
                <i data-lucide="home" class="w-4 h-4"></i> 
                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
        </div>
    </nav>

    <main class="relative z-10 p-4 md:p-8 container mx-auto max-w-[1600px] min-h-[calc(100vh-100px)]">

        <div class="grid grid-cols-12 gap-6 animate-fade-in h-full">
            <!-- Left Panel -->
            <div class="col-span-12 lg:col-span-4 flex flex-col gap-5 h-full">
                <div class="glass-panel p-6 rounded-2xl relative flex flex-col h-full">
                    <h2 class="text-lg font-bold mb-1 flex items-center gap-2">
                        <i data-lucide="book-open-check" class="text-emerald-400"></i> Knowledge Pipeline
                    </h2>
                    <p class="text-xs opacity-60 mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Supports: .txt, .csv, .json)</p>
                    
                    <div class="p-4 rounded-xl border border-[var(--border-color)] bg-[var(--bg-main)] mb-4 opacity-80">
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('local-file-upload').click()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-xs border border-[var(--border-color)] transition-colors text-[var(--text-main)]">
                                    <i data-lucide="paperclip" class="w-3 h-3 text-blue-400"></i> Attach File
                                </button>
                                <input type="file" id="local-file-upload" class="hidden" accept=".txt,.csv,.json,.md" onchange="handleFileUpload(this)">
                                
                                <button onclick="handleSheetImport()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-xs border border-[var(--border-color)] transition-colors text-[var(--text-main)]">
                                    <i data-lucide="link" class="w-3 h-3 text-green-400"></i> Link URL
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="relative flex-1 min-h-[200px]">
                        <textarea id="knowledge-input" class="w-full h-full bg-[var(--bg-main)] border border-[var(--border-color)] rounded-xl p-4 font-mono text-sm focus:border-cyan-500 outline-none resize-none leading-relaxed transition-all placeholder-slate-500" 
                        placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢, ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                        <div class="absolute bottom-2 right-2 text-[10px] opacity-50 bg-[var(--bg-main)] px-2 rounded border border-[var(--border-color)]" id="token-count">0 chars</div>
                    </div>

                    <div id="nlp-visualizer" class="hidden mt-4 p-4 bg-[var(--bg-main)] rounded-xl border border-[var(--border-color)]">
                        <h4 class="text-xs font-bold text-purple-400 mb-2 flex justify-between items-center">
                            <span><i data-lucide="cpu" class="w-3 h-3 inline mr-1"></i> NLP Training Core</span>
                            <span class="text-[10px] opacity-50" id="proc-speed">0 words/s</span>
                        </h4>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] opacity-60 mb-1">
                                <span>1. Tokenization & Extraction</span>
                                <span id="step-1-status" class="text-yellow-500">Waiting...</span>
                            </div>
                            <div id="vis-tokens" class="h-24 bg-black/30 rounded-lg p-2 overflow-y-auto flex flex-wrap content-start gap-1 scroller border border-[var(--border-color)] font-mono text-[10px]">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-[10px] opacity-60 mb-1">
                                <span>2. Vector Embedding (1024-dim)</span>
                                <span id="step-2-status" class="text-slate-500">...</span>
                            </div>
                            <div id="vis-vectors" class="h-20 bg-black/40 rounded-lg p-2 overflow-hidden font-mono text-[8px] text-green-500/80 leading-none break-all relative border border-[var(--border-color)]">
                            </div>
                        </div>

                        <div id="train-confirm-area" class="hidden mt-4 pt-3 border-t border-[var(--border-color)] text-center">
                            <p class="text-xs text-green-400 mb-2 font-bold"><i data-lucide="check-circle" class="w-3 h-3 inline"></i> Deep Learning Complete</p>
                            <button onclick="confirmTraining()" class="w-full py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white rounded-lg text-sm font-bold shadow-lg animate-pulse transition-all">
                                Save Model to Memory
                            </button>
                        </div>
                    </div>

                    <button onclick="startTextTraining()" id="btn-start-train" class="w-full mt-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg transition-all flex justify-center items-center gap-2">
                        <i data-lucide="zap"></i> Start Training Process
                    </button>
                </div>
            </div>

            <!-- Right Panel: Chat -->
            <div class="col-span-12 lg:col-span-8 flex flex-col h-[calc(100vh-140px)]">
                <div class="glass-panel flex-1 rounded-2xl flex flex-col overflow-hidden relative">
                    <div class="p-4 border-b border-[var(--border-color)] flex items-center justify-between z-10 bg-[var(--bg-panel)]">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center border border-indigo-500/30">
                                <i data-lucide="bot" class="text-indigo-400 w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">AI Research Assistant</h3>
                                <p class="text-[10px] opacity-60 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Gemini Pro Active
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <div class="flex items-center bg-[var(--bg-main)] rounded-lg border border-[var(--border-color)] px-2 py-1">
                                <span class="text-[16px] opacity-60 mr-2">Source:</span>
                                <select id="chat-source" onchange="handleSourceChange(this)" class="bg-transparent text-xs font-bold outline-none cursor-pointer text-[var(--text-main)] max-w-[100px] md:max-w-[150px]">
                                    <option value="api">1. üåê General AI</option>
                                    <option value="hybrid">2. üß† Trained Memory (Hybrid)</option>
                                    <option value="strict">3. üîí Only Data Training</option>
                                    <option value="offline">4. üö´ Offline Logic (No API)</option>
                                </select>
                            </div>

                            <div class="flex items-center bg-[var(--bg-main)] rounded-lg border border-[var(--border-color)] px-2 py-1 hidden md:flex" title="Limit Response Length to save tokens">
                                <span class="text-[10px] opacity-60 mr-2"><i data-lucide="scissors" class="w-3 h-3"></i>:</span>
                                <select id="chat-length" class="bg-transparent text-xs font-bold outline-none cursor-pointer text-[var(--text-main)]">
                                    <option value="short">‚ö° Short (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î)</option>
                                    <option value="medium" selected>üìù Normal</option>
                                    <option value="long">üìö Detailed</option>
                                </select>
                            </div>

                            <button onclick="clearChat()" class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg flex items-center gap-2 text-xs font-bold transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> <span class="hidden md:inline">New Chat</span>
                            </button>
                        </div>
                    </div>

                    <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6 bg-[var(--bg-main)]/50 relative">
                        <div class="flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center border border-indigo-500/30"><i data-lucide="bot" class="w-4 h-4 text-indigo-400"></i></div>
                            <div class="glass-panel p-4 rounded-2xl rounded-tl-none max-w-[85%] text-sm">
                                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏ô ‡∏à‡∏£‡∏±‡∏ç‡∏ç‡∏π ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤<br>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ñ‡∏£‡∏±‡∏ö
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-[var(--border-color)] z-10 bg-[var(--bg-panel)]">
                        <div id="chat-attachment-preview" class="hidden mb-2 px-3 py-1.5 text-xs text-blue-500 bg-blue-500/10 rounded-lg border border-blue-500/20 flex justify-between items-center w-fit max-w-full">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i data-lucide="file" class="w-3 h-3 flex-shrink-0"></i>
                                <span id="chat-file-name" class="truncate font-semibold">filename.docx</span>
                            </div>
                            <button onclick="clearChatAttachment()" class="ml-2 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>

                        <form onsubmit="handleChatSubmit(event)" class="flex gap-2 items-center">
                            <button type="button" onclick="document.getElementById('chat-file-upload').click()" class="p-3 bg-[var(--bg-main)] hover:bg-[var(--accent-color)] hover:text-white border border-[var(--border-color)] rounded-xl transition-all text-[var(--text-muted)]" title="Attach File">
                                <i data-lucide="paperclip" class="w-5 h-5"></i>
                            </button>
                            <input type="file" id="chat-file-upload" class="hidden" onchange="handleChatFileSelect(this)">
                            
                            <input type="text" id="user-input" class="flex-1 bg-[var(--bg-main)] border border-[var(--border-color)] rounded-xl px-4 py-3 text-sm focus:border-cyan-500 outline-none transition-all" placeholder="‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Knowledge)...">
                            <button type="submit" class="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-500"><i data-lucide="send" class="w-5 h-5"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- API Status Modal -->
    <div id="api-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-md w-full shadow-2xl relative">
            <button onclick="toggleAPIModal()" class="absolute top-4 right-4 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="activity" class="text-green-500"></i> API Health Monitor</h3>
            <div class="space-y-2 max-h-[300px] overflow-y-auto scroller pr-2" id="api-status-list">
            </div>
            <div class="mt-4 pt-4 border-t border-[var(--border-color)] text-[10px] opacity-60 text-center">
                System automatically rotates keys if Quota Exceeded (429) or Error occurs.
            </div>
        </div>
    </div>

<script>
    const API_KEYS = [
        "AIzaSyDiqXPAnfMICeehtGSC6VwDJaH9HqTIa-E",
        "AIzaSyAuGmhGGfVIgdcBS-bDPu06I_fQpIy2Sng",
        "AIzaSyAXn2RnKle5RdJsD74PHVQbQAcOkPffkb4",
    ];
    
    let keyHealth = API_KEYS.map((k, i) => ({
        id: i + 1,
        key: k,
        status: 'ready',
        msg: 'Ready'
    }));

    let currentKeyIndex = 0;
    let memory = ["‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏à‡∏£‡∏±‡∏ç‡∏ç‡∏π ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡∏Å"];
    let currentChatFile = null;
    let lastUserQuestion = "";
    
    function loadMemory() {
        const saved = localStorage.getItem('ai_memory');
        if(saved) {
            try {
                const parsed = JSON.parse(saved);
                if(parsed.length > 0) memory = parsed;
            } catch(e) { console.error("Load Memory Error", e); }
        }
    }

    function saveMemoryToStorage() {
        localStorage.setItem('ai_memory', JSON.stringify(memory));
    }

    window.addEventListener('storage', (e) => {
        if(e.key === 'ai_memory') {
            loadMemory();
            showAlert("System Sync", "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Training Center ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        }
    });

    loadMemory();

    function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const textArea = document.getElementById('knowledge-input');
            const timestamp = new Date().toLocaleTimeString();
            textArea.value += (textArea.value ? "\n\n" : "") + `[File: ${file.name} @ ${timestamp}]\n` + text;
            
            document.getElementById('token-count').innerText = textArea.value.length + " chars";
            showAlert("File Attached", `Successfully loaded content from ${file.name}`);
        };
        reader.readAsText(file);
    }

    function handleSheetImport() {
        const url = prompt("Enter CSV/Google Sheet URL:");
        if(url) {
            const textArea = document.getElementById('knowledge-input');
            textArea.value += (textArea.value ? "\n\n" : "") + `[Linked URL: ${url}]\nSimulated data load...`;
            document.getElementById('token-count').innerText = textArea.value.length + " chars";
        }
    }

    async function startTextTraining() {
        const input = document.getElementById('knowledge-input').value.trim();
        if(!input) return showAlert("Error", "Please enter data or attach a file first");

        document.getElementById('nlp-visualizer').classList.remove('hidden');
        document.getElementById('btn-start-train').classList.add('hidden');
        
        const visTokens = document.getElementById('vis-tokens');
        visTokens.innerHTML = '';
        document.getElementById('vis-vectors').innerHTML = '';
        
        let tokens = input.split(/[\s\n]+/);
        if(tokens.length < input.length / 20) {
            tokens = input.match(/.{1,10}/g) || [];
        }
        
        const totalTokens = tokens.length;
        let processedCount = 0;
        
        document.getElementById('step-1-status').innerHTML = `<span class="animate-pulse text-yellow-500">Initializing Pipeline...</span>`;

        const chunkSize = 20;
        let index = 0;
        let startTime = Date.now();

        function processChunk() {
            const chunkEnd = Math.min(index + chunkSize, totalTokens);
            let fragment = document.createDocumentFragment();
            
            for (let i = index; i < chunkEnd; i++) {
                const token = tokens[i];
                if (!token) continue;
                
                const span = document.createElement('span');
                const isConcept = token.length > 5 || /[\u0E00-\u0E7F]/.test(token);
                
                span.className = isConcept 
                    ? "inline-block px-1.5 py-0.5 m-0.5 bg-blue-500/20 text-blue-300 text-[10px] rounded border border-blue-500/30 animate-fade-in" 
                    : "inline-block px-1 m-0.5 text-slate-500 text-[10px]";
                span.innerText = token;
                fragment.appendChild(span);
            }
            
            visTokens.appendChild(fragment);
            visTokens.scrollTop = visTokens.scrollHeight;
            
            if (visTokens.children.length > 300) {
                for(let k=0; k<chunkSize; k++) {
                    if(visTokens.firstChild) visTokens.removeChild(visTokens.firstChild);
                }
            }

            processedCount = chunkEnd;
            
            const elapsed = (Date.now() - startTime) / 1000;
            const speed = Math.round(processedCount / (elapsed || 1));
            document.getElementById('proc-speed').innerText = `${speed} words/s`;
            document.getElementById('step-1-status').innerHTML = `<span class="text-yellow-500">Scanning & Tokenizing: ${processedCount}/${totalTokens}</span>`;

            index += chunkSize;

            if (index < totalTokens) {
                requestAnimationFrame(processChunk);
            } else {
                document.getElementById('step-1-status').innerHTML = `<span class="text-green-500 font-bold">Extraction Complete (${totalTokens} tokens)</span>`;
                startDeepVectorization();
            }
        }

        processChunk();
    }

    function startDeepVectorization() {
        const visVectors = document.getElementById('vis-vectors');
        document.getElementById('step-2-status').innerHTML = `<span class="animate-pulse text-blue-400">Generating Embeddings...</span>`;
        
        let progress = 0;
        visVectors.innerHTML = "";

        const interval = setInterval(() => {
            const chunk = Array(12).fill(0).map(() => Math.random().toFixed(4)).join(' ');
            const row = document.createElement('div');
            row.className = "text-[8px] whitespace-nowrap opacity-0 animate-fade-in text-emerald-500 font-mono";
            row.innerText = `[VEC-${progress}] ${chunk} ...`;
            visVectors.appendChild(row);
            visVectors.scrollTop = visVectors.scrollHeight;

            progress += 5;
            
            if (progress >= 100) {
                clearInterval(interval);
                document.getElementById('step-2-status').innerHTML = `<span class="text-green-500 font-bold">Vectorized 1024-Dimensions Ready</span>`;
                document.getElementById('train-confirm-area').classList.remove('hidden');
            }
        }, 50);
    }

    function confirmTraining() {
        const input = document.getElementById('knowledge-input').value;
        memory.push(input);
        saveMemoryToStorage();
        
        showAlert("Training Complete", "Data has been vectorized and saved to Trained Memory.");
        
        document.getElementById('knowledge-input').value = '';
        document.getElementById('token-count').innerText = "0 chars";
        document.getElementById('nlp-visualizer').classList.add('hidden');
        document.getElementById('train-confirm-area').classList.add('hidden');
        document.getElementById('btn-start-train').classList.remove('hidden');
    }

    function handleChatFileSelect(input) {
        const file = input.files[0];
        if (file) {
            currentChatFile = file;
            document.getElementById('chat-file-name').innerText = file.name;
            document.getElementById('chat-attachment-preview').classList.remove('hidden');
            document.getElementById('chat-attachment-preview').classList.add('flex');
        }
    }

    function clearChatAttachment() {
        currentChatFile = null;
        document.getElementById('chat-file-upload').value = "";
        document.getElementById('chat-attachment-preview').classList.add('hidden');
        document.getElementById('chat-attachment-preview').classList.remove('flex');
    }

    function handleSourceChange(select) {
        const input = document.getElementById('user-input');
        input.className = "flex-1 bg-[var(--bg-main)] border rounded-xl px-4 py-3 text-sm focus:border-cyan-500 outline-none transition-all";
        
        if (select.value === 'hybrid') {
            input.placeholder = "‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô (AI + Memory)...";
            input.classList.add('border-blue-500');
        } else if (select.value === 'strict') {
            input.placeholder = "‡∏ñ‡∏≤‡∏°‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô (Strict Mode)...";
            input.classList.add('border-emerald-500');
        } else if (select.value === 'offline') {
            input.placeholder = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏à‡∏≤‡∏Å Memory (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ AI)...";
            input.classList.add('border-slate-500');
        } else {
            input.placeholder = "‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Knowledge)...";
            input.classList.add('border-[var(--border-color)]');
        }
    }

    function toggleAPIModal() {
        const modal = document.getElementById('api-modal');
        if(modal.classList.contains('hidden')) {
            renderAPIStatus();
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    }

    function renderAPIStatus() {
        const list = document.getElementById('api-status-list');
        list.innerHTML = "";
        
        keyHealth.forEach((k, index) => {
            let colorClass = "status-ready";
            let textClass = "text-[var(--text-muted)]";
            
            if (k.status === 'working') { colorClass = "status-working"; textClass = "text-yellow-400"; }
            if (k.status === 'active') { colorClass = "status-active"; textClass = "text-green-400"; }
            if (k.status === 'dead') { colorClass = "status-dead"; textClass = "text-red-400 line-through opacity-50"; }
            
            const maskedKey = k.key.substring(0, 4) + "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + k.key.substring(k.key.length - 4);
            
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-2 rounded-lg bg-black/10 border border-[var(--border-color)]";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="status-dot ${colorClass}"></div>
                    <div>
                        <div class="text-xs font-bold ${textClass}">Key #${index + 1}</div>
                        <div class="text-[10px] opacity-40 font-mono">${maskedKey}</div>
                    </div>
                </div>
                <div class="text-[10px] font-bold ${textClass}">${k.msg}</div>
            `;
            list.appendChild(div);
        });
    }
    
    async function callGeminiAPI(payload, loadingId) {
        let lastError = null;
        const startKeyIndex = currentKeyIndex;
        
        for (let i = 0; i < API_KEYS.length; i++) {
            const actualIndex = (startKeyIndex + i) % API_KEYS.length;
            const apiKey = API_KEYS[actualIndex];

            keyHealth[actualIndex].status = 'working';
            keyHealth[actualIndex].msg = 'Connecting...';
            renderAPIStatus();

            try {
                if (loadingId) {
                    const loadingElem = document.querySelector(`#${loadingId} .glass-panel`);
                    if (loadingElem) {
                        loadingElem.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Processing... (Key #${actualIndex + 1})`;
                        lucide.createIcons();
                    }
                }

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });

                if (res.status === 429) {
                    throw new Error("Quota Exceeded (429)");
                }
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `HTTP Error ${res.status}`);
                }

                keyHealth[actualIndex].status = 'active';
                keyHealth[actualIndex].msg = 'Active (200 OK)';
                
                keyHealth.forEach((k, idx) => {
                    if(idx !== actualIndex && k.status === 'active') {
                        k.status = 'ready'; 
                        k.msg = 'Ready'; 
                    }
                });
                
                renderAPIStatus();
                currentKeyIndex = actualIndex;
                
                return await res.json();

            } catch (e) {
                lastError = e;
                console.warn(`Key #${actualIndex + 1} failed: ${e.message}`);
                
                keyHealth[actualIndex].status = 'dead';
                keyHealth[actualIndex].msg = e.message.includes('429') ? 'Quota Exceeded' : 'Error';
                renderAPIStatus();
                
                if (loadingId) {
                    const loadingElem = document.querySelector(`#${loadingId} .glass-panel`);
                    if (loadingElem) {
                        loadingElem.innerHTML = `<span class="text-orange-400 font-bold"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i> Key #${actualIndex + 1} Failed! Switching...</span>`;
                        lucide.createIcons();
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        throw new Error(`System Busy: All ${API_KEYS.length} keys failed. Last error: ${lastError?.message}`);
    }

    async function handleChatSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('user-input');
        const msg = input.value.trim();
        const source = document.getElementById('chat-source').value;
        const lengthMode = document.getElementById('chat-length').value;
        
        if (!msg && !currentChatFile) return;

        let userDisplayMsg = msg;
        let contextMsg = msg;

        if (currentChatFile) {
            userDisplayMsg = (msg ? msg + "<br>" : "") + `<div class='inline-flex items-center gap-2 bg-black/10 px-2 py-1 rounded text-xs mt-1'><i data-lucide='paperclip' class='w-3 h-3'></i> ${currentChatFile.name}</div>`;
            contextMsg = (msg ? msg + "\n" : "") + `[User Attached File: ${currentChatFile.name}]`;
        }
        
        lastUserQuestion = contextMsg;
        addMsg('user', userDisplayMsg);
        input.value = '';
        clearChatAttachment();
        
        if(source !== 'api') {
            if(memory.length <= 1) {
                setTimeout(() => {
                    addMsg('ai', `‚ö†Ô∏è <b>Memory Empty:</b> ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`);
                }, 500);
                return;
            }
        }

        if (source === 'offline') {
            const tempId = "thinking-" + Date.now();
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.id = tempId;
            div.className = "flex gap-4";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0"><i data-lucide="cpu" class="w-4 h-4 text-white"></i></div><div class="glass-panel p-4 rounded-2xl rounded-tl-none text-sm opacity-60 flex items-center gap-2"><i data-lucide="search" class="w-3 h-3 animate-bounce"></i> Searching Local Memory...</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            lucide.createIcons();

            setTimeout(() => {
                document.getElementById(tempId).remove();
                const keywords = contextMsg.toLowerCase().split(/[\s,]+/);
                const results = memory.filter(doc => keywords.some(k => k.length > 2 && doc.toLowerCase().includes(k)));

                if (results.length > 0) {
                    const content = results.map(r => `> ${r.substring(0, 150)}...`).join('\n\n');
                    addMsg('ai', `<b>[OFFLINE MODE]</b> ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö:\n\n${content}\n\n*‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÄ‡∏õ‡πä‡∏∞‡πÜ (Keyword Matching) ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏≠‡∏á AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏ö*`);
                } else {
                    addMsg('ai', `<b>[OFFLINE MODE]</b> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô Memory ‡∏Ñ‡∏£‡∏±‡∏ö`);
                }
            }, 800);
            return;
        }

        let maxTokens = 500;
        let styleInstruction = "Answer clearly and moderately.";

        if (lengthMode === 'short') {
            maxTokens = 150;
            styleInstruction = "Answer very briefly and concisely. Do not elaborate unnecessarily. Limit to 2-3 key sentences.";
        } else if (lengthMode === 'long') {
            maxTokens = 2000;
            styleInstruction = "Answer in detail. Provide comprehensive explanations, examples, or breakdowns if applicable.";
        }

        let prompt = "";
        const context = memory.join('\n\n--- NEXT DOCUMENT ---\n\n');

        if(source === 'strict') {
            prompt = `You are a strict research assistant AI. Answer using ONLY the CONTEXT below. If not found, say "Not found in Trained Memory".\n\nINSTRUCTION: ${styleInstruction}\n\nCONTEXT:\n${context}\n\nUSER QUESTION:\n${contextMsg}\n\nANSWER:`;
        } else if (source === 'hybrid') {
            prompt = `You are a smart research assistant AI. Use CONTEXT as primary truth but can use general knowledge.\n\nINSTRUCTION: ${styleInstruction}\n\nCONTEXT:\n${context}\n\nUSER QUESTION:\n${contextMsg}\n\nANSWER:`;
        } else {
            prompt = `You are a helpful AI Research Assistant. Answer the following question in Thai.\n\nINSTRUCTION: ${styleInstruction}\n\nQ: ${contextMsg}`;
        }

        try {
            const tempId = "thinking-" + Date.now();
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.id = tempId;
            div.className = "flex gap-4";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-4 h-4 text-indigo-400"></i></div><div class="glass-panel p-4 rounded-2xl rounded-tl-none text-sm opacity-60 flex items-center gap-2"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Initializing...</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            lucide.createIcons();

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    maxOutputTokens: maxTokens,
                    temperature: 0.7
                }
            };

            const data = await callGeminiAPI(payload, tempId);
            
            document.getElementById(tempId).remove();

            if (data.candidates && data.candidates[0].content) {
                addMsg('ai', data.candidates[0].content.parts[0].text);
            } else {
                console.error("Gemini Error:", data);
                let detail = "";
                if (data.promptFeedback) detail = `(Safety Block: ${JSON.stringify(data.promptFeedback)})`;
                addMsg('ai', `Error: AI did not return a response. <br><span class="text-xs text-red-300 opacity-80">${detail}</span>`);
            }
        } catch(e) {
            document.querySelectorAll('[id^="thinking-"]').forEach(el => el.remove());
            addMsg('ai', `<span class="text-red-400 font-bold">Connection Failed:</span> ${e.message}`);
        }
    }

    function addMsg(role, text) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        const msgId = "msg-" + Date.now();

        let actionButtons = "";
        if(role === 'ai') {
            actionButtons = `
                <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-[var(--border-color)]">
                    <button onclick="enableEdit('${msgId}')" class="text-[10px] text-blue-400 hover:underline flex items-center gap-1"><i data-lucide="edit-3" class="w-3 h-3"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏™‡∏≠‡∏ô (Correct)</button>
                    <button onclick="copyToClipboard('${msgId}')" class="text-[10px] opacity-50 hover:opacity-100 flex items-center gap-1"><i data-lucide="copy" class="w-3 h-3"></i> Copy</button>
                </div>
            `;
        }

        div.className = "flex gap-4 " + (role === 'user' ? "flex-row-reverse" : "");
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full ${role==='user'?'bg-slate-500':'bg-indigo-500/20'} flex items-center justify-center flex-shrink-0"><i data-lucide="${role==='user'?'user':'bot'}" class="w-4 h-4"></i></div>
            <div class="glass-panel p-4 rounded-2xl ${role==='user'?'bg-blue-600 border-none text-white':'rounded-tl-none'} max-w-[85%] text-sm group">
                <div id="${msgId}-content">${marked.parse(text)}</div>
                <div id="${msgId}-edit-area" class="hidden mt-2">
                     <textarea id="${msgId}-textarea" class="w-full bg-black/20 border border-[var(--border-color)] rounded p-2 text-xs mb-2 h-24"></textarea>
                     <button onclick="saveCorrection('${msgId}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs">Save & Teach</button>
                     <button onclick="cancelEdit('${msgId}')" class="px-3 py-1 bg-white/10 rounded text-xs ml-1">Cancel</button>
                </div>
                ${actionButtons}
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        lucide.createIcons();
    }

    function enableEdit(msgId) {
        const contentDiv = document.getElementById(`${msgId}-content`);
        const editArea = document.getElementById(`${msgId}-edit-area`);
        const textarea = document.getElementById(`${msgId}-textarea`);
        textarea.value = contentDiv.innerText.trim();
        contentDiv.classList.add('hidden');
        editArea.classList.remove('hidden');
    }

    function cancelEdit(msgId) {
        document.getElementById(`${msgId}-content`).classList.remove('hidden');
        document.getElementById(`${msgId}-edit-area`).classList.add('hidden');
    }

    function saveCorrection(msgId) {
        const newText = document.getElementById(`${msgId}-textarea`).value;
        document.getElementById(`${msgId}-content`).innerHTML = marked.parse(newText);
        cancelEdit(msgId);
        const teachingEntry = `[Human Correction]\nQ: ${lastUserQuestion}\nA: ${newText}`;
        memory.push(teachingEntry);
        saveMemoryToStorage();
        showAlert("AI Learned!", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÉ‡∏ô Memory ‡πÅ‡∏•‡πâ‡∏ß AI ‡∏à‡∏∞‡∏à‡∏≥‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
    }

    function copyToClipboard(msgId) {
        const text = document.getElementById(`${msgId}-content`).innerText;
        navigator.clipboard.writeText(text);
    }

    function clearChat() {
        const box = document.getElementById('chat-box');
        box.innerHTML = `
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center border border-indigo-500/30"><i data-lucide="bot" class="w-4 h-4 text-indigo-400"></i></div>
                <div class="glass-panel p-4 rounded-2xl rounded-tl-none max-w-[85%] text-sm">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö (New Chat)<br>‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
                </div>
            </div>
        `;
        clearChatAttachment();
        lucide.createIcons();
        showAlert("Chat Cleared", "‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ä‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡πÑ‡∏ß‡πâ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)");
    }

    function showAlert(t,m) {
        alert(`${t}\n\n${m}`);
    }

    lucide.createIcons();
</script>
</body>
</html>
