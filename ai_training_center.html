<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Center - Enhanced Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg-main: #f8fafc; --bg-panel: rgba(255, 255, 255, 0.9); --text-main: #0f172a; --text-muted: #64748b; --border-color: rgba(0, 0, 0, 0.1); --accent-color: #0284c7; }
        [data-theme="dark"] { --bg-main: #020617; --bg-panel: rgba(15, 23, 42, 0.6); --text-main: #e2e8f0; --text-muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.08); --accent-color: #0ea5e9; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.5s, color 0.5s; }
        .glass-panel { background: var(--bg-panel); backdrop-filter: blur(12px); border: 1px solid var(--border-color); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05); }
        .animate-float { animation: float 8s ease-in-out infinite; }
        @keyframes float { 0% { transform: translate(0, 0px); } 50% { transform: translate(0, -20px); } 100% { transform: translate(0, 0px); } }
        .tab-active { background: var(--accent-color); color: white; box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }
        .tab-inactive { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
        .level-card { border: 2px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .level-card:hover { border-color: var(--accent-color); background: rgba(14, 165, 233, 0.05); }
        .level-card.selected { border-color: var(--accent-color); background: rgba(14, 165, 233, 0.1); box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }
        .key-status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .key-active { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .key-failed { background: #ef4444; }
        .key-unused { background: #6b7280; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden" data-theme="light">
    <!-- Background Effects -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-orange-600/10 rounded-full blur-[120px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-yellow-600/10 rounded-full blur-[120px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <!-- Navigation -->
    <nav class="relative z-50 px-6 py-4 border-b border-[var(--border-color)] glass-panel">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="#" class="p-2.5 bg-gradient-to-br from-orange-500 to-yellow-400 rounded-xl shadow-lg"><i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i></a>
                <div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-yellow-400">AI Training Center</h1>
                    <p class="text-[10px] opacity-60">Enhanced Edition - Multi-Key System</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- API Status Indicator -->
                <div class="hidden md:flex items-center gap-2 px-3 py-2 bg-slate-500/10 rounded-xl border border-[var(--border-color)]">
                    <span class="key-status-indicator key-unused" id="api-status-indicator"></span>
                    <span class="text-xs font-semibold" id="api-status-text">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
                </div>

                <button onclick="openSettingsModal()" class="px-3 py-2 bg-slate-500/10 hover:bg-slate-500/20 border border-[var(--border-color)] rounded-xl text-sm font-semibold flex items-center gap-2 transition-colors" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Keys">
                    <i data-lucide="key" class="w-4 h-4"></i> <span class="hidden sm:inline">API Keys</span>
                </button>

                <div class="flex bg-[var(--bg-main)] rounded-lg p-1 border border-[var(--border-color)]">
                    <button onclick="setTheme('dark')" class="p-1.5 rounded hover:bg-slate-800 hover:text-white text-[var(--text-muted)]"><i data-lucide="moon" class="w-4 h-4"></i></button>
                    <button onclick="setTheme('light')" class="p-1.5 rounded hover:bg-slate-200 hover:text-black text-[var(--text-muted)]"><i data-lucide="sun" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="relative z-10 p-4 md:p-8 container mx-auto max-w-[1600px]">
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 justify-center flex-wrap">
            <button onclick="switchTab('manage')" id="tab-manage" class="tab-active px-6 py-2 rounded-xl text-sm font-semibold transition-all"><i data-lucide="database" class="w-4 h-4 inline mr-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="switchTab('templates')" id="tab-templates" class="tab-inactive px-6 py-2 rounded-xl text-sm font-semibold transition-all hover:bg-white/5"><i data-lucide="layers" class="w-4 h-4 inline mr-2"></i> Templates</button>
            <button onclick="switchTab('stats')" id="tab-stats" class="tab-inactive px-6 py-2 rounded-xl text-sm font-semibold transition-all hover:bg-white/5"><i data-lucide="bar-chart" class="w-4 h-4 inline mr-2"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        </div>

        <!-- Content: Manage -->
        <div id="content-manage" class="grid grid-cols-12 gap-6">
            <!-- Left: Memory List -->
            <div class="col-span-12 lg:col-span-8">
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Memory Database</h2>
                        <button onclick="exportMemory()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Export JSON</button>
                    </div>
                    <div id="memory-list" class="space-y-2 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="col-span-12 lg:col-span-4">
                <div class="glass-panel p-6 rounded-2xl space-y-4">
                    <h2 class="text-lg font-bold mb-2">Tools & Actions</h2>
                    
                    <!-- Manual Add -->
                    <div class="bg-[var(--bg-main)] p-4 rounded-xl border border-[var(--border-color)]">
                        <h3 class="text-sm font-semibold mb-2 flex items-center gap-2"><i data-lucide="edit-3" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
                        <textarea id="new-data" class="w-full h-24 bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg p-2 text-sm outline-none resize-none mb-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."></textarea>
                        <button onclick="addNewData()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>

                    <!-- AI Actions -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openConfigModal('url')" class="p-4 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 rounded-xl text-blue-600 transition-all flex flex-col items-center gap-2 group cursor-pointer relative z-10">
                            <div class="p-3 bg-blue-500 rounded-full text-white group-hover:scale-110 transition-transform pointer-events-none">
                                <i data-lucide="link" class="w-5 h-5"></i>
                            </div>
                            <span class="text-sm font-bold pointer-events-none">Import URL</span>
                        </button>

                        <button onclick="openConfigModal('generate')" class="p-4 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 rounded-xl text-purple-600 transition-all flex flex-col items-center gap-2 group cursor-pointer relative z-10">
                            <div class="p-3 bg-purple-500 rounded-full text-white group-hover:scale-110 transition-transform pointer-events-none">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                            </div>
                            <span class="text-sm font-bold pointer-events-none">Generate</span>
                        </button>
                    </div>

                    <!-- Import/Clear -->
                    <div class="flex gap-2">
                         <input type="file" id="import-json" accept=".json" class="hidden" onchange="importJSON(this)">
                        <button onclick="document.getElementById('import-json').click()" class="flex-1 py-3 bg-[var(--bg-main)] hover:bg-[var(--border-color)] border border-[var(--border-color)] rounded-xl text-sm font-semibold flex justify-center items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4"></i> Import JSON
                        </button>
                        <button onclick="requestClearMemory()" class="px-4 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 rounded-xl">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content: Templates -->
        <div id="content-templates" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="glass-panel p-6 rounded-2xl hover:scale-105 transition-transform cursor-pointer" onclick="loadTemplate('medical')">
                <div class="flex items-center gap-3 mb-3">
                    <div class="p-3 bg-red-500/20 rounded-xl"><i data-lucide="heart-pulse" class="w-6 h-6 text-red-500"></i></div>
                    <h3 class="font-bold">Medical Research</h3>
                </div>
                <p class="text-sm opacity-70">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</p>
            </div>
            <div class="glass-panel p-6 rounded-2xl hover:scale-105 transition-transform cursor-pointer" onclick="loadTemplate('statistics')">
                <div class="flex items-center gap-3 mb-3">
                    <div class="p-3 bg-blue-500/20 rounded-xl"><i data-lucide="bar-chart-3" class="w-6 h-6 text-blue-500"></i></div>
                    <h3 class="font-bold">Statistics Reference</h3>
                </div>
                <p class="text-sm opacity-70">‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>
            </div>
            <div class="glass-panel p-6 rounded-2xl hover:scale-105 transition-transform cursor-pointer" onclick="loadTemplate('research')">
                <div class="flex items-center gap-3 mb-3">
                    <div class="p-3 bg-purple-500/20 rounded-xl"><i data-lucide="book-open" class="w-6 h-6 text-purple-500"></i></div>
                    <h3 class="font-bold">Research Methods</h3>
                </div>
                <p class="text-sm opacity-70">‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢</p>
            </div>
        </div>

        <!-- Content: Stats -->
        <div id="content-stats" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="database" class="w-5 h-5 text-emerald-500"></i>
                    <h3 class="font-bold">Total Data Entries</h3>
                </div>
                <p class="text-3xl font-bold text-emerald-500" id="stat-total">0</p>
            </div>
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-blue-500"></i>
                    <h3 class="font-bold">Total Characters</h3>
                </div>
                <p class="text-3xl font-bold text-blue-500" id="stat-chars">0</p>
            </div>
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="clock" class="w-5 h-5 text-purple-500"></i>
                    <h3 class="font-bold">Last Updated</h3>
                </div>
                <p class="text-lg font-bold text-purple-500" id="stat-updated">N/A</p>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-2xl w-full shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-500/20 rounded-lg"><i data-lucide="key" class="w-5 h-5"></i></div>
                    <h3 class="text-lg font-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Keys (Multi-Key System)</h3>
                </div>
                <button onclick="closeSettingsModal()" class="text-[var(--text-muted)] hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-4">
                <p class="text-xs text-blue-600 font-semibold mb-2">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</p>
                <ul class="text-xs text-[var(--text-muted)] space-y-1 list-disc list-inside">
                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API Keys ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î Rate Limit</li>
                    <li>Keys ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Default Pool: <strong class="text-blue-600">3 keys</strong></li>
                    <li>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Custom Keys ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤)</li>
                    <li>‡∏£‡∏±‡∏ö Free API Key ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: <a href="https://aistudio.google.com/" target="_blank" class="text-blue-500 hover:underline font-semibold">aistudio.google.com</a></li>
                </ul>
            </div>

            <!-- Custom API Keys Management -->
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">Custom API Keys ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                <div id="custom-keys-list" class="space-y-2 mb-3">
                    <!-- Dynamic list will be inserted here -->
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-custom-key" class="flex-1 bg-[var(--bg-main)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 ring-[var(--accent-color)]" placeholder="AIzaSy... (‡∏ß‡∏≤‡∏á API Key ‡πÉ‡∏´‡∏°‡πà)">
                    <button onclick="addCustomKey()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
            </div>

            <!-- Default Keys Info -->
            <div class="bg-slate-500/10 rounded-xl p-4">
                <p class="text-xs font-bold mb-2 flex items-center gap-2">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> Default API Keys Pool
                </p>
                <p class="text-xs opacity-70 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ Keys ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ):</p>
                <div class="space-y-1" id="default-keys-display">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-4 border-t border-[var(--border-color)]">
                <button onclick="testAPIKeys()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">
                    <i data-lucide="zap" class="w-4 h-4 inline mr-1"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Keys
                </button>
                <button onclick="closeSettingsModal()" class="flex-1 py-2 bg-slate-500/10 hover:bg-slate-500/20 rounded-lg text-sm font-bold">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-md w-full shadow-2xl relative transform transition-all scale-100">
            <button onclick="closeConfigModal()" class="absolute top-4 right-4 text-[var(--text-muted)] hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 rounded-xl" id="config-icon-bg">
                    <div id="config-icon-container" class="flex items-center justify-center">
                        <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                    </div>
                </div>
                <h3 class="text-xl font-bold" id="config-title">Title</h3>
            </div>

            <div class="mb-5">
                <label class="block text-sm font-semibold mb-2" id="config-label">Label</label>
                <input type="text" id="config-input" class="w-full bg-[var(--bg-main)] border border-[var(--border-color)] rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 ring-[var(--accent-color)]" placeholder="...">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detail Level)</label>
                <div class="grid grid-cols-3 gap-2">
                    <div onclick="selectConfigLevel('short')" id="lvl-short" class="level-card p-3 rounded-xl text-center">
                        <div class="text-2xl mb-1">‚ö°</div>
                        <div class="text-xs font-bold">‡∏™‡∏±‡πâ‡∏ô</div>
                        <div class="text-[9px] opacity-60">Concise</div>
                    </div>
                    <div onclick="selectConfigLevel('medium')" id="lvl-medium" class="level-card selected p-3 rounded-xl text-center">
                        <div class="text-2xl mb-1">üìù</div>
                        <div class="text-xs font-bold">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</div>
                        <div class="text-[9px] opacity-60">Standard</div>
                    </div>
                    <div onclick="selectConfigLevel('detailed')" id="lvl-detailed" class="level-card p-3 rounded-xl text-center">
                        <div class="text-2xl mb-1">üìö</div>
                        <div class="text-xs font-bold">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        <div class="text-[9px] opacity-60">In-depth</div>
                    </div>
                </div>
            </div>

            <button onclick="handleConfigSubmit()" class="w-full py-3 bg-[var(--accent-color)] hover:opacity-90 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 flex justify-center items-center gap-2">
                <i data-lucide="play" class="w-4 h-4 fill-current"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Process)
            </button>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-sm w-full shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="inline-flex p-3 bg-blue-500/20 rounded-full mb-3 text-blue-500">
                    <i data-lucide="info" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold mb-2" id="msg-title">Notification</h3>
                <p class="text-sm opacity-80" id="msg-body">Message details here...</p>
            </div>
            <button onclick="closeMessageModal()" class="w-full py-2 bg-[var(--accent-color)] hover:opacity-90 text-white rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á (OK)</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-sm w-full shadow-2xl relative">
            <div class="text-center mb-6">
                <div class="inline-flex p-3 bg-yellow-500/20 rounded-full mb-3 text-yellow-500">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold mb-2" id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                <p class="text-sm opacity-80" id="confirm-body">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal(false)" class="flex-1 py-2 bg-slate-500/10 hover:bg-slate-500/20 border border-[var(--border-color)] rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="closeConfirmModal(true)" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- AI Processing Modal -->
    <div id="ai-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-sm px-4">
        <div class="glass-panel p-6 rounded-2xl max-w-2xl w-full shadow-2xl relative max-h-[80vh] overflow-hidden flex flex-col">
            <button onclick="closeAIModal()" class="absolute top-4 right-4 hover:text-red-500 z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="flex items-center gap-3 mb-4 pb-4 border-b border-[var(--border-color)]">
                <div class="p-3 bg-blue-500/20 rounded-xl animate-pulse">
                    <i data-lucide="brain" class="w-6 h-6 text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold" id="modal-title">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h3>
                    <p class="text-xs opacity-60" id="modal-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                </div>
            </div>

            <div class="space-y-3 mb-4" id="progress-steps">
                <div class="flex items-start gap-3 opacity-30" id="step-1">
                    <div class="step-icon-container w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i data-lucide="loader-2" class="w-3 h-3 text-white animate-spin hidden"></i>
                        <i data-lucide="circle" class="w-3 h-3 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI</p>
                        <p class="text-xs opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</p>
                    </div>
                </div>

                <div class="flex items-start gap-3 opacity-30" id="step-2">
                    <div class="step-icon-container w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i data-lucide="loader-2" class="w-3 h-3 text-white animate-spin hidden"></i>
                        <i data-lucide="circle" class="w-3 h-3 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</p>
                        <p class="text-xs opacity-60">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...</p>
                    </div>
                </div>

                <div class="flex items-start gap-3 opacity-30" id="step-3">
                    <div class="step-icon-container w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i data-lucide="loader-2" class="w-3 h-3 text-white animate-spin hidden"></i>
                        <i data-lucide="circle" class="w-3 h-3 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>
                        <p class="text-xs opacity-60">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden">
                <div class="bg-[var(--bg-main)] rounded-xl p-4 h-full overflow-y-auto border border-[var(--border-color)]" id="ai-result-container">
                    <div class="text-sm font-mono leading-relaxed whitespace-pre-wrap" id="ai-result-text"></div>
                    <span class="inline-block w-2 h-4 bg-blue-500 animate-pulse ml-1" id="typing-cursor"></span>
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-4 border-t border-[var(--border-color)]" id="modal-actions">
                <button onclick="closeAIModal()" class="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-[var(--border-color)] rounded-lg text-sm">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

<script>
    // ========================================
    // CORE CONFIGURATION
    // ========================================
    
    // Default API Keys Pool (Built-in)
    const DEFAULT_API_KEYS = [
        "AIzaSyDiqXPAnfMICeehtGSC6VwDJaH9HqTIa-E",
        "AIzaSyAuGmhGGfVIgdcBS-bDPu06I_fQpIy2Sng",
        "AIzaSyAXn2RnKle5RdJsD74PHVQbQAcOkPffkb4"
    ];

    // State Management
    let memory = ["‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏à‡∏£‡∏±‡∏ç‡∏ç‡∏π ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡∏Å"];
    let typingSpeed = 5;
    let currentMode = 'url';
    let currentLevel = 'medium';
    let pendingConfirmCallback = null;
    
    // API Key Management
    let customAPIKeys = [];
    let currentKeyIndex = 0;
    let keyFailureCount = {};

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    
    function setTheme(t) { 
        document.body.setAttribute('data-theme', t); 
        localStorage.setItem('theme', t); 
    }
    setTheme(localStorage.getItem('theme') || 'light');

    function refreshIcons() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ========================================
    // MODAL UTILITIES
    // ========================================
    
    function showMessage(title, body) {
        document.getElementById('msg-title').innerText = title || 'Notification';
        document.getElementById('msg-body').innerText = body || '';
        document.getElementById('message-modal').classList.remove('hidden');
        refreshIcons();
    }

    function closeMessageModal() {
        document.getElementById('message-modal').classList.add('hidden');
    }

    function showConfirm(title, body, callback) {
        document.getElementById('confirm-title').innerText = title || 'Confirmation';
        document.getElementById('confirm-body').innerText = body || 'Are you sure?';
        document.getElementById('confirm-modal').classList.remove('hidden');
        pendingConfirmCallback = callback;
        refreshIcons();
    }

    function closeConfirmModal(confirmed) {
        document.getElementById('confirm-modal').classList.add('hidden');
        if (confirmed && pendingConfirmCallback) {
            pendingConfirmCallback();
        }
        pendingConfirmCallback = null;
    }

    // ========================================
    // API KEY MANAGEMENT
    // ========================================
    
    function loadCustomKeys() {
        const stored = localStorage.getItem('custom_api_keys');
        if (stored) {
            try {
                customAPIKeys = JSON.parse(stored);
            } catch(e) {
                customAPIKeys = [];
            }
        }
    }

    function saveCustomKeys() {
        localStorage.setItem('custom_api_keys', JSON.stringify(customAPIKeys));
    }

    function getAllAPIKeys() {
        // Custom keys have priority
        return [...customAPIKeys, ...DEFAULT_API_KEYS];
    }

    function getNextAPIKey() {
        const allKeys = getAllAPIKeys();
        if (allKeys.length === 0) {
            throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ API Keys ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        }
        
        // Rotate to next key
        const key = allKeys[currentKeyIndex % allKeys.length];
        currentKeyIndex = (currentKeyIndex + 1) % allKeys.length;
        
        return key;
    }

    function markKeyAsFailed(key) {
        if (!keyFailureCount[key]) {
            keyFailureCount[key] = 0;
        }
        keyFailureCount[key]++;
    }

    function updateAPIStatus(connected, message) {
        const indicator = document.getElementById('api-status-indicator');
        const text = document.getElementById('api-status-text');
        
        if (connected) {
            indicator.className = 'key-status-indicator key-active';
            text.innerText = message || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
        } else {
            indicator.className = 'key-status-indicator key-failed';
            text.innerText = message || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        }
    }

    // ========================================
    // SETTINGS MODAL
    // ========================================
    
    function openSettingsModal() {
        loadCustomKeys();
        renderCustomKeysList();
        renderDefaultKeysList();
        document.getElementById('settings-modal').classList.remove('hidden');
        refreshIcons();
    }

    function closeSettingsModal() {
        document.getElementById('settings-modal').classList.add('hidden');
    }

    function renderCustomKeysList() {
        const container = document.getElementById('custom-keys-list');
        
        if (customAPIKeys.length === 0) {
            container.innerHTML = '<div class="text-xs opacity-50 text-center py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Custom Keys</div>';
            return;
        }

        container.innerHTML = customAPIKeys.map((key, index) => {
            const masked = key.substring(0, 20) + '...' + key.substring(key.length - 4);
            const failures = keyFailureCount[key] || 0;
            const statusClass = failures > 0 ? 'key-failed' : 'key-unused';
            
            return `
                <div class="flex items-center gap-2 bg-[var(--bg-main)] border border-[var(--border-color)] rounded-lg px-3 py-2">
                    <span class="key-status-indicator ${statusClass}"></span>
                    <span class="flex-1 text-xs font-mono">${masked}</span>
                    ${failures > 0 ? `<span class="text-xs text-red-500">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failures}x</span>` : ''}
                    <button onclick="removeCustomKey(${index})" class="p-1 hover:bg-red-500/10 rounded text-red-500">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
        }).join('');
        
        refreshIcons();
    }

    function renderDefaultKeysList() {
        const container = document.getElementById('default-keys-display');
        
        container.innerHTML = DEFAULT_API_KEYS.map((key, index) => {
            const masked = key.substring(0, 20) + '...' + key.substring(key.length - 4);
            const failures = keyFailureCount[key] || 0;
            const statusClass = failures > 0 ? 'key-failed' : 'key-unused';
            
            return `
                <div class="flex items-center gap-2 text-xs">
                    <span class="key-status-indicator ${statusClass}"></span>
                    <span class="font-mono opacity-70">${masked}</span>
                    ${failures > 0 ? `<span class="text-red-500 ml-auto">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failures}x</span>` : ''}
                </div>
            `;
        }).join('');
    }

    function addCustomKey() {
        const input = document.getElementById('new-custom-key');
        const key = input.value.trim();
        
        if (!key) {
            return showMessage("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key");
        }
        
        if (!key.startsWith('AIzaSy')) {
            return showMessage("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AIzaSy)");
        }
        
        if (customAPIKeys.includes(key) || DEFAULT_API_KEYS.includes(key)) {
            return showMessage("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "API Key ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        }
        
        customAPIKeys.push(key);
        saveCustomKeys();
        renderCustomKeysList();
        input.value = '';
        
        showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÄ‡∏û‡∏¥‡πà‡∏° API Key ‡πÅ‡∏•‡πâ‡∏ß");
    }

    function removeCustomKey(index) {
        showConfirm("‡∏•‡∏ö API Key", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Key ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", () => {
            customAPIKeys.splice(index, 1);
            saveCustomKeys();
            renderCustomKeysList();
        });
    }

    async function testAPIKeys() {
        const allKeys = getAllAPIKeys();
        
        if (allKeys.length === 0) {
            return showMessage("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡πÑ‡∏°‡πà‡∏°‡∏µ API Keys ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        }

        showMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...", `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${allKeys.length} Keys...`);
        
        let successCount = 0;
        let failCount = 0;
        
        for (const key of allKeys) {
            try {
                await callGeminiAPI("Test", 50, key);
                successCount++;
            } catch(e) {
                failCount++;
                markKeyAsFailed(key);
            }
        }
        
        renderCustomKeysList();
        renderDefaultKeysList();
        
        showMessage("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö", `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} keys\n‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failCount} keys`);
        
        if (successCount > 0) {
            updateAPIStatus(true, `${successCount} keys ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`);
        } else {
            updateAPIStatus(false, '‡∏ó‡∏∏‡∏Å Keys ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
    }

    // ========================================
    // MEMORY MANAGEMENT
    // ========================================
    
    function loadMemory() { 
        const s = localStorage.getItem('ai_memory'); 
        if(s) try { const p = JSON.parse(s); if(p.length > 0) memory = p; } catch(e){} 
        renderMemory(); 
        updateStats(); 
    }
    
    function saveMemory() { 
        localStorage.setItem('ai_memory', JSON.stringify(memory)); 
        renderMemory(); 
        updateStats(); 
    }
    
    function renderMemory() { 
        const l = document.getElementById('memory-list'); 
        l.innerHTML = ''; 
        
        if(!memory.length) { 
            l.innerHTML = '<div class="text-center py-8 opacity-50 flex flex-col items-center"><i data-lucide="inbox" class="w-8 h-8 mb-2"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Memory</div>'; 
            refreshIcons(); 
            return; 
        } 
        
        memory.forEach((i, x) => { 
            const d = document.createElement('div'); 
            d.className = "glass-panel p-4 rounded-xl flex justify-between items-start gap-3 hover:bg-white/5 transition-colors"; 
            d.innerHTML = `
                <div class="flex-1">
                    <div class="text-[10px] opacity-50 mb-1 font-mono uppercase tracking-wider">Entry #${String(x + 1).padStart(3, '0')}</div>
                    <div class="text-sm line-clamp-3">${i}</div>
                </div>
                <button onclick="requestDeleteMemory(${x})" class="p-2 hover:bg-red-500/10 rounded-lg text-red-500 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            `; 
            l.appendChild(d); 
        }); 
        
        refreshIcons(); 
    }
    
    function addNewData() { 
        const i = document.getElementById('new-data'); 
        const d = i.value.trim(); 
        if(!d) return showMessage("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); 
        memory.push(d); 
        saveMemory(); 
        i.value = ''; 
    }

    function requestDeleteMemory(x) {
        showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", () => {
            memory.splice(x, 1); 
            saveMemory();
        });
    }

    function requestClearMemory() {
        showConfirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Memory ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", () => {
            memory = ["‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏à‡∏£‡∏±‡∏ç‡∏ç‡∏π ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡∏Å"]; 
            saveMemory(); 
            showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        });
    }

    function exportMemory() { 
        const d = JSON.stringify(memory, null, 2); 
        const b = new Blob([d], {type: 'application/json'}); 
        const u = URL.createObjectURL(b); 
        const a = document.createElement('a'); 
        a.href = u; 
        a.download = `ai_memory_export_${Date.now()}.json`; 
        a.click(); 
        URL.revokeObjectURL(u); 
    }

    function importJSON(i) { 
        const f = i.files[0]; 
        if(!f) return; 
        const r = new FileReader(); 
        r.onload = e => { 
            try { 
                const d = JSON.parse(e.target.result); 
                if(Array.isArray(d)) { 
                    memory = d; 
                    saveMemory(); 
                    showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); 
                } else showMessage("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); 
            } catch {
                showMessage("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏î‡πâ");
            } 
        }; 
        r.readAsText(f); 
    }

    function updateStats() { 
        document.getElementById('stat-total').innerText = memory.length; 
        const t = memory.reduce((s, i) => s + i.length, 0); 
        document.getElementById('stat-chars').innerText = t.toLocaleString(); 
        document.getElementById('stat-updated').innerText = new Date().toLocaleTimeString('th-TH'); 
    }

    // ========================================
    // TAB SWITCHING
    // ========================================
    
    function switchTab(t) { 
        ['manage', 'templates', 'stats'].forEach(x => { 
            document.getElementById(`content-${x}`).classList.toggle('hidden', x !== t); 
            const b = document.getElementById(`tab-${x}`); 
            b.className = x === t ? 
                "tab-active px-6 py-2 rounded-xl text-sm font-semibold transition-all" : 
                "tab-inactive px-6 py-2 rounded-xl text-sm font-semibold transition-all hover:bg-white/5"; 
        }); 
        refreshIcons(); 
    }

    // ========================================
    // TEMPLATES
    // ========================================
    
    function loadTemplate(t) { 
        let d = ""; 
        
        if(t === 'medical') {
            d = `‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç

1. ‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ (Epidemiology): ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
2. ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô: ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î HbA1c < 7%
3. ‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î: ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà
4. ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ: ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á (Screening)`;
        } else if(t === 'statistics') {
            d = `‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥

1. Mean (‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢): ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
2. Standard Deviation (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô): ‡∏ß‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
3. P-value: ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô ‡∏ñ‡πâ‡∏≤ < 0.05 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
4. Correlation (‡∏™‡∏´‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå): ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ 2 ‡∏ï‡∏±‡∏ß ‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á -1 ‡∏ñ‡∏∂‡∏á 1
5. t-test: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°`;
        } else {
            d = `‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢

1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (Research Question)
2. ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏° (Literature Review)
3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢: Quantitative ‡∏´‡∏£‡∏∑‡∏≠ Qualitative
4. ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Collection)
5. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Analysis)
6. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏†‡∏¥‡∏õ‡∏£‡∏≤‡∏¢‡∏ú‡∏• (Discussion)`;
        }
        
        memory.push(d); 
        saveMemory(); 
        showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏û‡∏¥‡πà‡∏° Template: ${t} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`); 
        switchTab('manage'); 
    }

    // ========================================
    // CONFIG MODAL
    // ========================================
    
    function openConfigModal(mode) {
        currentMode = mode;
        const modal = document.getElementById('config-modal');
        const iconContainer = document.getElementById('config-icon-container');
        const iconBg = document.getElementById('config-icon-bg');
        const title = document.getElementById('config-title');
        const label = document.getElementById('config-label');
        const input = document.getElementById('config-input');

        modal.classList.remove('hidden');
        input.value = '';

        if(mode === 'url') {
            title.innerText = 'Import from URL';
            label.innerText = '‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (Paste URL)';
            input.placeholder = 'https://example.com/article';
            iconContainer.innerHTML = '<i data-lucide="link" class="w-6 h-6 text-white"></i>';
            iconBg.className = 'p-3 rounded-xl bg-blue-500';
        } else {
            title.innerText = 'Generate Knowledge';
            label.innerText = '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Topic)';
            input.placeholder = '‡πÄ‡∏ä‡πà‡∏ô: ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô Python';
            iconContainer.innerHTML = '<i data-lucide="sparkles" class="w-6 h-6 text-white"></i>';
            iconBg.className = 'p-3 rounded-xl bg-purple-500';
        }
        
        refreshIcons();
        selectConfigLevel('medium');
    }

    function closeConfigModal() {
        document.getElementById('config-modal').classList.add('hidden');
    }

    function selectConfigLevel(level) {
        currentLevel = level;
        ['short', 'medium', 'detailed'].forEach(l => {
            const el = document.getElementById(`lvl-${l}`);
            if(l === level) el.classList.add('selected');
            else el.classList.remove('selected');
        });
    }

    function handleConfigSubmit() {
        const val = document.getElementById('config-input').value.trim();
        if(!val) return showMessage("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        
        closeConfigModal();
        
        if(currentMode === 'url') {
            fetchAndSummarizeURL(val);
        } else {
            generateKnowledge(val);
        }
    }

    // ========================================
    // AI MODAL
    // ========================================
    
    function openAIModal(t, s) { 
        document.getElementById('ai-modal').classList.remove('hidden'); 
        document.getElementById('modal-title').innerText = t; 
        document.getElementById('modal-subtitle').innerText = s; 
        document.getElementById('ai-result-text').innerText = ''; 
        document.getElementById('typing-cursor').classList.remove('hidden'); 
        document.getElementById('modal-actions').innerHTML = `
            <button onclick="closeAIModal()" class="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-[var(--border-color)] rounded-lg text-sm">Cancel</button>
        `;
        
        for(let i=1; i<=3; i++) { 
            const e = document.getElementById(`step-${i}`); 
            e.classList.remove('opacity-100'); 
            e.classList.add('opacity-30'); 
            
            const iconContainer = e.querySelector('.step-icon-container');
            iconContainer.className = "step-icon-container w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center flex-shrink-0 mt-0.5";
            iconContainer.innerHTML = `
                <i data-lucide="loader-2" class="w-3 h-3 text-white animate-spin hidden"></i>
                <i data-lucide="circle" class="w-3 h-3 text-white"></i>
            `;
        } 
        
        refreshIcons(); 
    }
    
    function closeAIModal() { 
        document.getElementById('ai-modal').classList.add('hidden'); 
    }
    
    function updateStep(n, s) { 
        const e = document.getElementById(`step-${n}`); 
        if (!e) return;

        e.classList.remove('opacity-30'); 
        e.classList.add('opacity-100'); 
        
        const c = e.querySelector('.step-icon-container');
        const loaderIcon = c.children[0];
        const staticIcon = c.children[1];
        
        if(s === 'loading') { 
            c.classList.remove('bg-slate-500', 'bg-green-500'); 
            c.classList.add('bg-blue-500'); 
            if(loaderIcon) loaderIcon.classList.remove('hidden');
            if(staticIcon) staticIcon.classList.add('hidden');
        } else { 
            c.classList.remove('bg-slate-500', 'bg-blue-500'); 
            c.classList.add('bg-green-500'); 
            if(loaderIcon) loaderIcon.classList.add('hidden');
            if(staticIcon) staticIcon.classList.remove('hidden');
        } 
    }
    
    async function typeText(t) { 
        const c = document.getElementById('ai-result-text'); 
        const cu = document.getElementById('typing-cursor'); 
        c.innerText = ''; 
        
        const chunk = 5;
        for(let i = 0; i < t.length; i+=chunk) { 
            c.innerText += t.substring(i, i+chunk); 
            const r = document.getElementById('ai-result-container'); 
            r.scrollTop = r.scrollHeight; 
            await new Promise(resolve => setTimeout(resolve, typingSpeed)); 
        } 
        
        cu.classList.add('hidden'); 
    }

    // ========================================
    // GEMINI API WITH ROTATION
    // ========================================
    
    async function callGeminiAPI(prompt, maxTokens = 2000, specificKey = null) {
        const MAX_RETRIES = getAllAPIKeys().length;
        let lastError = null;
        
        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
            try {
                const keyToUse = specificKey || getNextAPIKey();
                const model = "gemini-1.5-flash";
                
                const payload = { 
                    contents: [{ parts: [{ text: prompt }] }], 
                    generationConfig: { 
                        maxOutputTokens: maxTokens, 
                        temperature: 0.7 
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${keyToUse}`, 
                    { 
                        method: 'POST', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify(payload) 
                    }
                );
                
                if (response.status === 429) {
                    // Rate limit - try next key
                    markKeyAsFailed(keyToUse);
                    console.warn(`Key rate limited, rotating to next key (attempt ${attempt + 1}/${MAX_RETRIES})`);
                    continue;
                }
                
                if (response.status === 403) {
                    markKeyAsFailed(keyToUse);
                    throw new Error("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö (403)");
                }
                
                if (!response.ok) {
                    const errBody = await response.text();
                    console.error("API Error:", errBody);
                    throw new Error(`HTTP ${response.status}: ${errBody}`);
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                    updateAPIStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    return data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    throw new Error(`AI Blocked: ${data.promptFeedback.blockReason}`);
                }
                
                throw new Error("No valid response from API");
                
            } catch(error) {
                lastError = error;
                
                if (specificKey || attempt === MAX_RETRIES - 1) {
                    updateAPIStatus(false, '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                    throw error;
                }
                
                console.warn(`Attempt ${attempt + 1} failed, trying next key...`);
            }
        }
        
        updateAPIStatus(false, '‡∏ó‡∏∏‡∏Å Keys ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        throw lastError || new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ");
    }

    // ========================================
    // URL FETCHING
    // ========================================
    
    async function fetchAndSummarizeURL(url) { 
        try { 
            new URL(url); 
        } catch { 
            return showMessage("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); 
        } 
        
        openAIModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', url); 
        
        try { 
            updateStep(1, 'loading'); 
            await new Promise(r => setTimeout(r, 500)); 
            updateStep(1, 'complete'); 
            
            updateStep(2, 'loading');
            document.getElementById('step-2').querySelector('.text-xs').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...';
            
            let webContent = '';
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error('Cannot fetch');
                
                const html = await response.text();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                ['script', 'style', 'nav', 'footer', 'iframe'].forEach(tag => {
                    const els = tempDiv.getElementsByTagName(tag);
                    for(let i = els.length - 1; i >= 0; i--) els[i].remove();
                });
                
                webContent = tempDiv.innerText.replace(/\s+/g, ' ').trim().substring(0, 15000);
            } catch {
                webContent = `URL: ${url} (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)`;
            }
            
            updateStep(2, 'complete'); 
            updateStep(3, 'loading');
            
            let prompt = "";
            let maxTokens = 1000;

            if (currentLevel === 'short') {
                prompt = `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î:\n\n${webContent}`;
                maxTokens = 500;
            } else if (currentLevel === 'medium') {
                prompt = `‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:\n\n${webContent}`;
                maxTokens = 1500;
            } else {
                prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:\n\n${webContent}`;
                maxTokens = 4000;
            }

            const summary = await callGeminiAPI(prompt, maxTokens);
            updateStep(3, 'complete'); 
            
            await typeText(summary); 
            
            const dataWithSource = `[Source: ${url}]\n[Level: ${currentLevel}]\n[Date: ${new Date().toLocaleString('th-TH')}]\n\n${summary}`; 
            memory.push(dataWithSource); 
            saveMemory(); 
            
            document.getElementById('modal-title').innerText = '‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå'; 
            document.getElementById('modal-subtitle').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß'; 
            document.getElementById('modal-actions').innerHTML = `
                <button onclick="closeAIModal(); switchTab('manage');" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold">
                    ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            `; 
            
        } catch (e) { 
            console.error(e);
            document.getElementById('modal-title').innerText = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; 
            document.getElementById('ai-result-text').innerText = `Error: ${e.message}`; 
            document.getElementById('modal-subtitle').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        } 
    }

    // ========================================
    // KNOWLEDGE GENERATION
    // ========================================
    
    async function generateKnowledge(topic) { 
        openAIModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${topic}`); 
        
        try { 
            updateStep(1, 'loading'); 
            await new Promise(r => setTimeout(r, 500)); 
            updateStep(1, 'complete'); 
            
            updateStep(2, 'loading'); 
            await new Promise(r => setTimeout(r, 800)); 
            updateStep(2, 'complete'); 
            
            updateStep(3, 'loading');
            
            let prompt = "";
            let maxTokens = 1000;

            if (currentLevel === 'short') {
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: "${topic}"\n‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ô‡∏¥‡∏¢‡∏≤‡∏° ‡πÅ‡∏•‡∏∞ 3 ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å`;
                maxTokens = 600;
            } else if (currentLevel === 'medium') {
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: "${topic}"\n‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á`;
                maxTokens = 1500;
            } else {
                prompt = `‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: "${topic}"\n‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°: ‡∏ó‡∏§‡∏©‡∏é‡∏µ ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°`;
                maxTokens = 4000;
            }

            const knowledge = await callGeminiAPI(prompt, maxTokens);
            updateStep(3, 'complete'); 
            
            await typeText(knowledge); 
            
            const dataWithMeta = `[Topic: ${topic}]\n[Level: ${currentLevel}]\n[Generated: ${new Date().toLocaleString('th-TH')}]\n\n${knowledge}`; 
            memory.push(dataWithMeta); 
            saveMemory(); 
            
            document.getElementById('modal-title').innerText = '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; 
            document.getElementById('modal-subtitle').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß'; 
            document.getElementById('modal-actions').innerHTML = `
                <button onclick="closeAIModal(); switchTab('manage');" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold">
                    ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            `; 
            
        } catch (e) { 
            console.error(e);
            document.getElementById('modal-title').innerText = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; 
            document.getElementById('ai-result-text').innerText = `Error: ${e.message}`; 
            document.getElementById('modal-subtitle').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        } 
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    
    loadMemory();
    loadCustomKeys();
    
    // Auto-test keys on first load
    setTimeout(() => {
        const allKeys = getAllAPIKeys();
        if (allKeys.length > 0) {
            updateAPIStatus(true, `${allKeys.length} keys ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`);
        }
    }, 1000);
    
</script>
</body>
</html>
