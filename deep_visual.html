<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Visual - AI Training Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-main: #f8fafc; --bg-panel: rgba(255, 255, 255, 0.9); --text-main: #0f172a; --text-muted: #64748b; --border-color: rgba(0, 0, 0, 0.1); --accent-color: #0284c7; }
        [data-theme="dark"] { --bg-main: #020617; --bg-panel: rgba(15, 23, 42, 0.6); --text-main: #e2e8f0; --text-muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.08); --accent-color: #0ea5e9; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.5s, color 0.5s; }
        .glass-panel { background: var(--bg-panel); backdrop-filter: blur(12px); border: 1px solid var(--border-color); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05); }
        .animate-float { animation: float 8s ease-in-out infinite; }
        @keyframes float { 0% { transform: translate(0, 0px); } 50% { transform: translate(0, -20px); } 100% { transform: translate(0, 0px); } }
        canvas#draw-canvas { background: white; cursor: crosshair; border-radius: 8px; border: 2px dashed var(--text-muted); touch-action: none; }
        .step-card-active { border-color: var(--accent-color); background: rgba(14, 165, 233, 0.1); }
        .step-card-inactive { border-color: var(--border-color); background: transparent; }
        
        /* Matrix Effect */
        .matrix-font { font-family: 'JetBrains Mono', monospace; line-height: 1; letter-spacing: 2px; }
        .digit-0 { opacity: 0.3; }
        .digit-1 { opacity: 1; font-weight: bold; color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }

        /* Tools */
        input[type="range"] { accent-color: var(--accent-color); }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden" data-theme="light">
    <!-- Background Elements -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[120px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-cyan-600/10 rounded-full blur-[120px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <!-- Modal for Comparison Results -->
    <div id="result-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative w-full max-w-4xl glass-panel rounded-2xl p-6 shadow-2xl border border-blue-500/30 transform transition-all scale-100">
            <button onclick="closeModal()" class="absolute top-4 right-4 p-2 hover:bg-black/10 rounded-full"><i data-lucide="x"></i></button>
            
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Analysis Result</h2>
                <p class="text-sm opacity-60">Visual Comparison & Similarity Score</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                <!-- Input Side -->
                <div class="flex flex-col items-center">
                    <div class="relative group">
                        <div class="absolute inset-0 bg-blue-500/20 blur-xl rounded-full"></div>
                        <img id="modal-input-img" class="relative w-48 h-48 object-cover rounded-xl border-2 border-blue-500 shadow-lg bg-black/10">
                    </div>
                    <div class="mt-4 text-sm font-bold text-blue-400">INPUT</div>
                    <div class="text-xs opacity-50">Image sent for inference</div>
                </div>

                <!-- Match Stats (Center) -->
                <div class="flex flex-col items-center justify-center space-y-4">
                    <div class="flex items-center gap-2">
                        <div class="h-px w-8 bg-gradient-to-r from-transparent to-blue-500"></div>
                        <div class="p-3 bg-white/5 rounded-full border border-white/10">
                            <i data-lucide="arrow-right-left" class="w-6 h-6 text-white/80"></i>
                        </div>
                        <div class="h-px w-8 bg-gradient-to-l from-transparent to-emerald-500"></div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-4xl font-bold font-mono" id="modal-score">0%</div>
                        <div class="text-xs uppercase tracking-widest opacity-60">Similarity</div>
                    </div>

                    <div id="modal-verdict" class="px-4 py-1 rounded-full text-xs font-bold border border-current">
                        MATCH FOUND
                    </div>
                </div>

                <!-- Match Side -->
                <div class="flex flex-col items-center">
                    <div class="relative group">
                        <div class="absolute inset-0 bg-emerald-500/20 blur-xl rounded-full"></div>
                        <img id="modal-match-img" class="relative w-48 h-48 object-cover rounded-xl border-2 border-emerald-500 shadow-lg bg-black/10">
                    </div>
                    <div class="mt-4 text-sm font-bold text-emerald-400">BEST MATCH</div>
                    <div class="text-xs opacity-50 font-mono" id="modal-match-label">Label: Unknown</div>
                </div>
            </div>

            <!-- Detailed Breakdown -->
            <div class="mt-8 pt-6 border-t border-[var(--border-color)]">
                <div class="flex justify-between items-end mb-2">
                    <h4 class="text-sm font-bold opacity-70">Model Confidence Distribution</h4>
                </div>
                <div class="space-y-3" id="modal-bars">
                    <!-- Bars injected by JS -->
                </div>
            </div>
            
            <div class="mt-6 flex justify-center">
                <button onclick="closeModal()" class="px-8 py-2 bg-white/10 hover:bg-white/20 border border-white/10 rounded-lg text-sm transition-colors">Close Analysis</button>
            </div>
        </div>
    </div>

    <nav class="relative z-50 px-6 py-4 border-b border-[var(--border-color)] glass-panel">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" class="p-2.5 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl shadow-lg"><i data-lucide="brain-circuit" class="w-6 h-6 text-white"></i></a>
                <div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Deep Visual Training</h1>
                    <p class="text-[10px] opacity-60">ฝึกอบรม AI ด้วยรูปภาพ</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="flex bg-[var(--bg-main)] rounded-lg p-1 border border-[var(--border-color)]">
                    <button onclick="setTheme('dark')" class="p-1.5 rounded hover:bg-slate-800 hover:text-white text-[var(--text-muted)]"><i data-lucide="moon" class="w-4 h-4"></i></button>
                    <button onclick="setTheme('light')" class="p-1.5 rounded hover:bg-slate-200 hover:text-black text-[var(--text-muted)]"><i data-lucide="sun" class="w-4 h-4"></i></button>
                </div>
                <a href="index.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-sm font-semibold flex items-center gap-2"><i data-lucide="home" class="w-4 h-4"></i> กลับหน้าหลัก</a>
            </div>
        </div>
    </nav>

    <main class="relative z-10 p-4 md:p-8 container mx-auto max-w-[1600px]">
        <div class="grid grid-cols-12 gap-6">
            <!-- Sidebar -->
            <div class="col-span-12 lg:col-span-3 flex flex-col gap-4">
                <div class="glass-panel p-6 rounded-2xl">
                    <h2 class="text-lg font-bold mb-4 text-blue-400 flex items-center gap-2"><i data-lucide="layers"></i> Deep Visual Pipeline</h2>
                    <div class="space-y-3">
                        <div onclick="visualStep(1)" id="v-step-1" class="step-card-active p-4 rounded-xl border cursor-pointer transition-all">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400"><i data-lucide="upload"></i></div>
                                <div><h3 class="font-bold text-sm">1. Dataset</h3><p class="text-[10px] opacity-60">Upload & Label</p></div>
                            </div>
                        </div>
                        <div onclick="visualStep(2)" id="v-step-2" class="step-card-inactive p-4 rounded-xl border cursor-pointer transition-all">
                            <div class="flex items-center gap-3">
                                <div class="bg-purple-500/20 p-2 rounded-lg text-purple-400"><i data-lucide="network"></i></div>
                                <div><h3 class="font-bold text-sm">2. Neural Network</h3><p class="text-[10px] opacity-60">CNN Architecture</p></div>
                            </div>
                        </div>
                        <div onclick="visualStep(3)" id="v-step-3" class="step-card-inactive p-4 rounded-xl border cursor-pointer transition-all">
                            <div class="flex items-center gap-3">
                                <div class="bg-orange-500/20 p-2 rounded-lg text-orange-400"><i data-lucide="zap"></i></div>
                                <div><h3 class="font-bold text-sm">3. Training</h3><p class="text-[10px] opacity-60">Backpropagation</p></div>
                            </div>
                        </div>
                        <div onclick="visualStep(4)" id="v-step-4" class="step-card-inactive p-4 rounded-xl border cursor-pointer transition-all">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-500/20 p-2 rounded-lg text-green-400"><i data-lucide="scan-eye"></i></div>
                                <div><h3 class="font-bold text-sm">4. Inference</h3><p class="text-[10px] opacity-60">Test & Predict</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Workspace -->
            <div class="col-span-12 lg:col-span-9">
                <div class="glass-panel rounded-2xl p-6 min-h-[600px] flex flex-col items-center" id="visual-workspace">
                    
                    <!-- Step 1: Dataset -->
                    <div id="visual-content-1" class="w-full h-full flex flex-col items-center justify-center">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold mb-2">Prepare Dataset</h3>
                            <p class="opacity-60 text-sm">อัปโหลดภาพเพื่อสอน AI (จะจำภาพเหล่านี้ไว้เปรียบเทียบ)</p>
                        </div>
                        <div id="train-camera-container" class="hidden w-full max-w-md flex-col items-center gap-2 mb-4 p-4 bg-black/20 rounded-xl">
                            <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden">
                                <video id="train-webcam" autoplay playsinline class="w-full h-full object-cover"></video>
                                <div class="absolute top-2 right-2 flex items-center gap-1 bg-red-600/80 text-white px-2 py-0.5 rounded text-[10px] animate-pulse">
                                    <div class="w-2 h-2 bg-white rounded-full"></div> REC
                                </div>
                            </div>
                            <div class="flex gap-2 w-full">
                                <button onclick="captureTrainingImage()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold flex justify-center items-center gap-2"><i data-lucide="camera"></i> Capture & Add</button>
                                <button onclick="closeTrainCamera()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">Close</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mb-4">
                            <select id="label-selector" class="bg-[var(--bg-main)] border border-[var(--border-color)] rounded-lg px-4 py-2 text-sm">
                                <option value="Normal">Label: Normal (ปกติ)</option>
                                <option value="Abnormal">Label: Abnormal (ผิดปกติ)</option>
                                <option value="Risk">Label: Risk (มีความเสี่ยง)</option>
                            </select>
                            <button onclick="document.getElementById('visual-upload').click()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus"></i> Add Images</button>
                            <button onclick="toggleTrainCamera()" class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="video"></i> Use Camera</button>
                            <input type="file" id="visual-upload" multiple accept="image/*" class="hidden" onchange="handleVisualUpload(this)">
                        </div>
                        <div id="dataset-grid" class="w-full max-w-3xl h-64 border-2 border-dashed border-[var(--border-color)] rounded-xl p-4 overflow-y-auto grid grid-cols-4 gap-2 bg-[var(--bg-main)]/30">
                            <div class="col-span-4 flex flex-col items-center justify-center h-full text-[var(--text-muted)]">
                                <i data-lucide="image-plus" class="w-8 h-8 mb-2 opacity-50"></i>
                                <span class="text-xs">No images yet. Upload or Capture to start.</span>
                            </div>
                        </div>
                        <button onclick="visualStep(2)" id="btn-next-step1" class="mt-6 px-8 py-2 bg-[var(--bg-main)] border border-[var(--border-color)] hover:border-blue-500 rounded-lg text-sm opacity-50 cursor-not-allowed" disabled>Next: Build Network ></button>
                    </div>

                    <!-- Step 2: Architecture -->
                    <div id="visual-content-2" class="w-full h-full hidden flex-col items-center">
                        <h3 class="text-xl font-bold mb-6 text-purple-400">CNN Architecture Visualization</h3>
                        <div class="flex items-center gap-2 overflow-x-auto p-4 w-full justify-center">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-white border border-slate-300 grid grid-cols-3 gap-0.5 p-0.5">
                                    <div class="bg-black/80"></div><div class="bg-black/20"></div><div class="bg-black/60"></div>
                                    <div class="bg-black/10"></div><div class="bg-black/90"></div><div class="bg-black/30"></div>
                                    <div class="bg-black/50"></div><div class="bg-black/40"></div><div class="bg-black/10"></div>
                                </div>
                                <span class="text-[10px] mt-2">Input Image</span>
                            </div>
                            <i data-lucide="arrow-right" class="opacity-50"></i>
                            <div class="flex flex-col items-center p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                <div class="space-y-1">
                                    <div class="w-12 h-1 bg-blue-500 rounded"></div>
                                    <div class="w-12 h-1 bg-blue-500 rounded"></div>
                                    <div class="w-12 h-1 bg-blue-500 rounded"></div>
                                </div>
                                <span class="text-[10px] mt-2 text-blue-400">Conv2D</span>
                            </div>
                            <i data-lucide="arrow-right" class="opacity-50"></i>
                            <div class="flex flex-col items-center p-2 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                <div class="w-8 h-8 border border-orange-500 grid grid-cols-2">
                                    <div class="bg-orange-500/50"></div><div></div>
                                    <div></div><div class="bg-orange-500/50"></div>
                                </div>
                                <span class="text-[10px] mt-2 text-orange-400">MaxPooling</span>
                            </div>
                            <i data-lucide="arrow-right" class="opacity-50"></i>
                            <div class="flex flex-col items-center">
                                <div class="h-16 w-2 bg-slate-500 rounded"></div>
                                <span class="text-[10px] mt-2">Flatten</span>
                            </div>
                            <i data-lucide="arrow-right" class="opacity-50"></i>
                            <div class="flex flex-col items-center p-2 bg-green-500/10 border border-green-500/30 rounded-lg">
                                <div class="flex gap-1">
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                </div>
                                <span class="text-[10px] mt-2 text-green-400">Softmax</span>
                            </div>
                        </div>
                        <button onclick="visualStep(3)" class="mt-6 px-8 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">Initialize & Train ></button>
                    </div>

                    <!-- Step 3: Training (Updated for Binary Visualization) -->
                    <div id="visual-content-3" class="w-full h-full hidden flex-col items-center justify-center">
                        <h3 class="text-xl font-bold mb-2 text-orange-400">Training Model...</h3>
                        <p class="text-xs opacity-60 mb-6">Digesting real images into binary features...</p>
                        
                        <div class="flex gap-8 items-center mb-6">
                            <!-- Source Image Container -->
                            <div class="flex flex-col items-center">
                                <div class="w-32 h-32 rounded-lg border-2 border-[var(--border-color)] overflow-hidden bg-black relative">
                                    <img id="train-current-img" class="w-full h-full object-cover opacity-80" src="">
                                    <div class="absolute inset-0 bg-orange-500/20 animate-pulse"></div>
                                </div>
                                <span class="text-xs mt-2 font-mono" id="train-current-label">Loading...</span>
                            </div>

                            <i data-lucide="arrow-right" class="w-6 h-6 text-orange-400 animate-pulse"></i>

                            <!-- Binary Matrix Container -->
                            <div class="flex flex-col items-center">
                                <div class="w-32 h-32 bg-black rounded-lg border border-green-500/50 p-2 overflow-hidden flex items-center justify-center">
                                    <div id="train-binary-view" class="matrix-font text-[6px] md:text-[8px] leading-none text-center break-all text-green-500 w-full h-full overflow-hidden whitespace-pre-wrap">
                                        <!-- 0s and 1s will be injected here -->
                                    </div>
                                </div>
                                <span class="text-xs mt-2 font-mono text-green-500">Feature Extraction</span>
                            </div>
                        </div>

                        <div class="w-full max-w-md bg-[var(--border-color)] h-2 rounded-full overflow-hidden relative">
                            <div id="train-progress" class="bg-gradient-to-r from-orange-500 to-red-500 h-full w-0 transition-all duration-300"></div>
                        </div>
                        
                        <div class="flex justify-between w-full max-w-md mt-2 text-xs font-mono">
                            <span id="epoch-status" class="opacity-60">Epoch 0/50</span>
                            <span id="loss-display" class="text-red-400">Loss: 1.00</span>
                        </div>
                    </div>

                    <!-- Step 4: Inference (ENHANCED) -->
                    <div id="visual-content-4" class="w-full h-full hidden flex-col items-center">
                        <h3 class="text-xl font-bold mb-4 text-green-400">Test Model</h3>
                        
                        <!-- Mode Selectors -->
                        <div class="flex gap-2 mb-6 bg-[var(--bg-main)] p-1 rounded-lg border border-[var(--border-color)]">
                            <button onclick="setInferMode('draw')" id="btn-infer-draw" class="px-4 py-1.5 rounded text-xs bg-white/10 font-bold">Draw</button>
                            <button onclick="setInferMode('upload')" id="btn-infer-upload" class="px-4 py-1.5 rounded text-xs hover:bg-white/5 opacity-60">Upload</button>
                            <button onclick="setInferMode('camera')" id="btn-infer-camera" class="px-4 py-1.5 rounded text-xs hover:bg-white/5 opacity-60">Camera</button>
                        </div>

                        <!-- LARGE INFERENCE CONTAINER -->
                        <div class="flex flex-col items-center w-full max-w-3xl">
                            
                            <!-- DRAWING MODE with TOOLS -->
                            <div id="infer-draw" class="infer-panel flex flex-col items-center gap-2">
                                <!-- Drawing Tools -->
                                <div class="flex items-center gap-4 bg-[var(--bg-panel)] p-2 rounded-xl border border-[var(--border-color)] mb-2 shadow-sm">
                                    <div class="flex flex-col items-center">
                                        <input type="color" id="draw-color" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0 overflow-hidden" onchange="setTool('brush')">
                                        <span class="text-[10px] opacity-60">Color</span>
                                    </div>
                                    <div class="h-8 w-px bg-[var(--border-color)]"></div>
                                    <div class="flex flex-col items-center w-24">
                                        <input type="range" id="draw-size" min="1" max="50" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span class="text-[10px] opacity-60">Size: <span id="size-val">10</span>px</span>
                                    </div>
                                    <div class="h-8 w-px bg-[var(--border-color)]"></div>
                                    <button onclick="setTool('eraser')" id="tool-eraser" class="p-2 rounded hover:bg-black/5 opacity-50 transition-all text-[var(--text-main)]" title="Eraser">
                                        <i data-lucide="eraser" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="setTool('brush')" id="tool-brush" class="p-2 rounded hover:bg-black/5 bg-blue-500/20 text-blue-500 transition-all" title="Brush">
                                        <i data-lucide="pencil" class="w-5 h-5"></i>
                                    </button>
                                    <div class="h-8 w-px bg-[var(--border-color)]"></div>
                                    <button onclick="clearCanvas()" class="p-2 rounded hover:bg-red-500/10 text-red-500 transition-all" title="Clear All">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>

                                <!-- Large Canvas -->
                                <canvas id="draw-canvas" width="500" height="500" class="max-w-full bg-white shadow-inner border border-slate-200"></canvas>
                            </div>

                            <!-- UPLOAD MODE (Upsized) -->
                            <div id="infer-upload" class="infer-panel hidden flex-col items-center justify-center w-[500px] h-[500px] max-w-full border-2 border-dashed border-[var(--border-color)] rounded-2xl bg-[var(--bg-main)]/30">
                                <input type="file" id="test-image-upload" class="hidden" onchange="handleTestImage(this)">
                                <button onclick="document.getElementById('test-image-upload').click()" class="flex flex-col items-center opacity-60 hover:opacity-100 transition-opacity">
                                    <i data-lucide="image-plus" class="w-16 h-16 mb-4 text-[var(--text-muted)]"></i>
                                    <span class="text-sm font-bold text-[var(--text-muted)]">Click to Select Image</span>
                                </button>
                                <img id="test-preview" class="hidden w-full h-full object-contain rounded-2xl">
                            </div>

                            <!-- CAMERA MODE (Upsized) -->
                            <div id="infer-camera" class="infer-panel hidden flex-col items-center">
                                <div class="w-[500px] h-[375px] max-w-full bg-black rounded-2xl overflow-hidden relative shadow-lg">
                                    <video id="webcam" autoplay playsinline class="w-full h-full object-cover"></video>
                                    <div class="absolute inset-0 flex items-center justify-center" id="cam-placeholder">
                                        <button onclick="startCamera()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-bold flex items-center gap-2">
                                            <i data-lucide="camera"></i> Start Camera
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="predict()" id="btn-predict" class="mt-8 px-12 py-3 bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-500 hover:to-green-500 text-white rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 transform hover:scale-105 transition-all">
                                <i data-lucide="scan-search"></i> Compare & Predict
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

<script>
    let visualDataset = [];
    let trainStream = null;
    let trainInterval;

    function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);

    function visualStep(step) {
        for(let i=1; i<=4; i++) {
            const card = document.getElementById(`v-step-${i}`);
            const content = document.getElementById(`visual-content-${i}`);
            if(i === step) {
                card.className = "step-card-active p-4 rounded-xl border cursor-pointer transition-all";
                content.classList.remove('hidden');
                content.classList.add('flex');
                if(step === 3) startTrainingSim();
                if(step === 4) initCanvas();
            } else {
                card.className = "step-card-inactive p-4 rounded-xl border cursor-pointer transition-all";
                content.classList.add('hidden');
                content.classList.remove('flex');
            }
        }
        lucide.createIcons();
    }

    // --- Camera & Dataset Handling ---

    async function toggleTrainCamera() {
        const container = document.getElementById('train-camera-container');
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            container.classList.add('flex');
            try {
                trainStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('train-webcam').srcObject = trainStream;
            } catch(e) {
                alert("Camera access denied");
                closeTrainCamera();
            }
        } else {
            closeTrainCamera();
        }
    }

    function closeTrainCamera() {
        const container = document.getElementById('train-camera-container');
        container.classList.add('hidden');
        container.classList.remove('flex');
        if (trainStream) {
            trainStream.getTracks().forEach(track => track.stop());
            trainStream = null;
        }
    }

    function captureTrainingImage() {
        const video = document.getElementById('train-webcam');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg');
        const label = document.getElementById('label-selector').value;
        addToDataset(dataUrl, label);
    }

    function handleVisualUpload(input) {
        const label = document.getElementById('label-selector').value;
        const files = Array.from(input.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => addToDataset(e.target.result, label);
            reader.readAsDataURL(file);
        });
    }

    function addToDataset(imgSrc, label) {
        const grid = document.getElementById('dataset-grid');
        if(visualDataset.length === 0) grid.innerHTML = ''; 

        const div = document.createElement('div');
        div.className = "relative group h-20 bg-black/20 rounded-lg overflow-hidden border border-[var(--border-color)]";
        div.innerHTML = `<img src="${imgSrc}" class="w-full h-full object-cover"><div class="absolute bottom-0 left-0 right-0 bg-black/60 text-[8px] text-white p-1 truncate">${label}</div>`;
        grid.appendChild(div);
        visualDataset.push({ img: imgSrc, label });

        document.getElementById('btn-next-step1').disabled = false;
        document.getElementById('btn-next-step1').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('btn-next-step1').classList.add('bg-blue-600', 'text-white');
    }

    // --- Training with Binary Visualization ---

    async function imageToBinaryString(imgSrc) {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                // Create small grid for binary text (e.g., 20x20)
                const size = 16;
                c.width = size;
                c.height = size;
                const ctx = c.getContext('2d');
                ctx.drawImage(img, 0, 0, size, size);
                const data = ctx.getImageData(0, 0, size, size).data;
                let binaryStr = "";
                for(let i=0; i<data.length; i+=4) {
                    // Simple threshold
                    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                    const bit = avg > 100 ? 0 : 1; // Dark is 1, Light is 0 (or vice versa)
                    // Wrap with span for styling
                    binaryStr += `<span class="digit-${bit}">${bit}</span>`;
                    if (((i/4)+1) % size === 0) binaryStr += "\n";
                    else binaryStr += " ";
                }
                resolve(binaryStr);
            };
            img.src = imgSrc;
        });
    }

    async function startTrainingSim() {
        if(visualDataset.length === 0) {
            // Fake data if empty
            document.getElementById('train-current-label').innerText = "Generating synthetic data...";
            document.getElementById('train-binary-view').innerHTML = "0 1 0 1 1 0<br>1 1 0 0 1 0<br>0 0 1 1 0 1";
        }

        let epoch = 0;
        let loss = 1.0;
        let imgIndex = 0;
        
        clearInterval(trainInterval);
        
        trainInterval = setInterval(async () => {
            epoch++;
            loss = Math.max(0.01, loss * 0.95);
            
            // UI Updates
            document.getElementById('train-progress').style.width = (epoch * 2) + "%";
            document.getElementById('epoch-status').innerText = `Epoch ${epoch}/50`;
            document.getElementById('loss-display').innerText = `Loss: ${loss.toFixed(3)}`;

            // Cycle through real images
            if(visualDataset.length > 0) {
                const currentData = visualDataset[imgIndex % visualDataset.length];
                document.getElementById('train-current-img').src = currentData.img;
                document.getElementById('train-current-label').innerText = `Learning: ${currentData.label}`;
                
                // Convert to binary visual
                const binHTML = await imageToBinaryString(currentData.img);
                document.getElementById('train-binary-view').innerHTML = binHTML;
                
                imgIndex++;
            } else {
                // Random binary noise if no images
                let noise = "";
                for(let i=0; i<100; i++) {
                    const b = Math.random() > 0.5 ? 1 : 0;
                    noise += `<span class="digit-${b}">${b}</span> ` + (i%10==0 ? "<br>" : "");
                }
                document.getElementById('train-binary-view').innerHTML = noise;
            }

            if(epoch >= 50) {
                clearInterval(trainInterval);
                setTimeout(() => visualStep(4), 1000);
            }
        }, 200); // Slower interval to see the images change
    }

    // --- Inference & Popup Logic (Enhanced) ---

    function setInferMode(mode) {
        document.querySelectorAll('.infer-panel').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.infer-panel').forEach(p => p.classList.remove('flex'));
        document.getElementById(`infer-${mode}`).classList.remove('hidden');
        document.getElementById(`infer-${mode}`).classList.add('flex');
        
        ['draw','upload','camera'].forEach(m => {
            const btn = document.getElementById(`btn-infer-${m}`);
            if(m === mode) {
                btn.classList.remove('opacity-60', 'hover:bg-white/5');
                btn.classList.add('bg-white/10', 'font-bold');
            } else {
                btn.classList.add('opacity-60', 'hover:bg-white/5');
                btn.classList.remove('bg-white/10', 'font-bold');
            }
        });
    }

    // Drawing State
    let isEraser = false;
    let currentCtx = null;

    function initCanvas() {
        const canvas = document.getElementById('draw-canvas');
        currentCtx = canvas.getContext('2d');
        
        // White background
        currentCtx.fillStyle = "white";
        currentCtx.fillRect(0,0, canvas.width, canvas.height);
        
        let painting = false;
        
        // Tools Listener
        const sizeSlider = document.getElementById('draw-size');
        sizeSlider.addEventListener('input', (e) => {
            document.getElementById('size-val').innerText = e.target.value;
        });

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // Handle touch events too
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // Adjust for canvas scaling in CSS
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startPosition(e) { 
            e.preventDefault(); 
            painting = true; 
            draw(e); 
        }
        function finishedPosition() { 
            painting = false; 
            currentCtx.beginPath(); 
        }
        function draw(e) {
            if(!painting) return;
            e.preventDefault();
            
            const pos = getPos(e);
            
            const color = document.getElementById('draw-color').value;
            const size = document.getElementById('draw-size').value;

            currentCtx.lineWidth = size;
            currentCtx.lineCap = 'round';
            currentCtx.lineJoin = 'round';
            currentCtx.strokeStyle = isEraser ? 'white' : color;
            
            currentCtx.lineTo(pos.x, pos.y);
            currentCtx.stroke();
            currentCtx.beginPath();
            currentCtx.moveTo(pos.x, pos.y);
        }

        // Mouse Events
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseleave', finishedPosition);

        // Touch Events
        canvas.addEventListener('touchstart', startPosition);
        canvas.addEventListener('touchend', finishedPosition);
        canvas.addEventListener('touchmove', draw);
    }

    function setTool(tool) {
        const btnBrush = document.getElementById('tool-brush');
        const btnEraser = document.getElementById('tool-eraser');
        
        if (tool === 'eraser') {
            isEraser = true;
            btnEraser.classList.remove('opacity-50');
            btnEraser.classList.add('bg-blue-500/20', 'text-blue-500');
            
            btnBrush.classList.add('opacity-50');
            btnBrush.classList.remove('bg-blue-500/20', 'text-blue-500');
        } else {
            isEraser = false;
            btnBrush.classList.remove('opacity-50');
            btnBrush.classList.add('bg-blue-500/20', 'text-blue-500');
            
            btnEraser.classList.add('opacity-50');
            btnEraser.classList.remove('bg-blue-500/20', 'text-blue-500');
        }
    }

    function clearCanvas() {
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "white";
        ctx.fillRect(0,0, canvas.width, canvas.height);
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('webcam').srcObject = stream;
            document.getElementById('cam-placeholder').classList.add('hidden');
        } catch(e) {
            alert("Camera not accessible");
        }
    }

    function handleTestImage(input) {
        const file = input.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('test-preview');
                img.src = e.target.result;
                img.classList.remove('hidden');
                // Hide the upload prompt
                input.nextElementSibling.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    async function getPixelData(source, w=64, h=64) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            if (typeof source === 'string') {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(ctx.getImageData(0, 0, w, h).data);
                };
                img.src = source;
            } else {
                ctx.drawImage(source, 0, 0, w, h);
                resolve(ctx.getImageData(0, 0, w, h).data);
            }
        });
    }

    function calculateSimilarity(pixels1, pixels2) {
        let diff = 0;
        for (let i = 0; i < pixels1.length; i += 4) {
            diff += Math.abs(pixels1[i] - pixels2[i]);
            diff += Math.abs(pixels1[i+1] - pixels2[i+1]);
            diff += Math.abs(pixels1[i+2] - pixels2[i+2]);
        }
        const maxDiff = (pixels1.length / 4) * 255 * 3;
        return Math.max(0, 100 * (1 - (diff / maxDiff)));
    }

    function closeModal() {
        document.getElementById('result-modal').classList.add('hidden');
    }

    async function predict() {
        if(visualDataset.length === 0) return alert("Please go to Step 1 and upload/label training data first.");

        const btn = document.getElementById('btn-predict');
        btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> Analyzing...`;
        lucide.createIcons();
        
        // 1. Get Input Source
        let inputSource;
        let inputDisplaySrc; // For displaying in modal
        if (!document.getElementById('infer-draw').classList.contains('hidden')) {
            const canvas = document.getElementById('draw-canvas');
            inputSource = canvas;
            inputDisplaySrc = canvas.toDataURL();
        } else if (!document.getElementById('infer-upload').classList.contains('hidden')) {
            const img = document.getElementById('test-preview');
            if(!img.src) { btn.innerHTML = `<i data-lucide="scan-search"></i> Compare & Predict`; lucide.createIcons(); return alert("Please upload an image first."); }
            inputSource = img.src;
            inputDisplaySrc = img.src;
        } else {
            const vid = document.getElementById('webcam');
            if(vid.paused) { btn.innerHTML = `<i data-lucide="scan-search"></i> Compare & Predict`; lucide.createIcons(); return alert("Camera not active"); }
            inputSource = vid;
            // Capture frame for modal
            const c = document.createElement('canvas');
            c.width = vid.videoWidth;
            c.height = vid.videoHeight;
            c.getContext('2d').drawImage(vid,0,0);
            inputDisplaySrc = c.toDataURL();
        }

        // 2. Perform Analysis
        const inputPixels = await getPixelData(inputSource);
        let matches = [];
        for (let data of visualDataset) {
            const trainPixels = await getPixelData(data.img);
            const similarity = calculateSimilarity(inputPixels, trainPixels);
            matches.push({ label: data.label, score: similarity, img: data.img });
        }

        matches.sort((a, b) => b.score - a.score);
        const bestMatch = matches[0];

        // 3. Prepare Stats
        let maxScores = { "Normal": 0, "Abnormal": 0, "Risk": 0 };
        matches.forEach(m => {
            if(m.score > maxScores[m.label]) maxScores[m.label] = m.score;
        });

        // Normalize softmax-ish
        const n = maxScores['Normal'] || 0;
        const a = maxScores['Abnormal'] || 0;
        const r = maxScores['Risk'] || 0;
        const total = n + a + r || 1; 
        
        // 4. Populate Modal
        document.getElementById('modal-input-img').src = inputDisplaySrc;
        document.getElementById('modal-match-img').src = bestMatch.img;
        document.getElementById('modal-match-label').innerText = `Label: ${bestMatch.label}`;
        document.getElementById('modal-score').innerText = `${bestMatch.score.toFixed(1)}%`;
        
        // Color code verdict
        const verdictEl = document.getElementById('modal-verdict');
        verdictEl.innerText = bestMatch.score > 80 ? "HIGH CONFIDENCE MATCH" : "LOW CONFIDENCE MATCH";
        verdictEl.className = bestMatch.score > 80 
            ? "px-4 py-1 rounded-full text-xs font-bold border border-green-500 text-green-500 bg-green-500/10"
            : "px-4 py-1 rounded-full text-xs font-bold border border-orange-500 text-orange-500 bg-orange-500/10";

        // Generate bars HTML
        const barsContainer = document.getElementById('modal-bars');
        barsContainer.innerHTML = `
            <div>
                <div class="flex justify-between text-xs mb-1"><span>Normal</span><span>${n.toFixed(1)}%</span></div>
                <div class="w-full h-2 bg-white/10 rounded-full"><div class="h-full bg-green-500 rounded-full" style="width: ${(n/total)*100}%"></div></div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1"><span>Abnormal</span><span>${a.toFixed(1)}%</span></div>
                <div class="w-full h-2 bg-white/10 rounded-full"><div class="h-full bg-red-500 rounded-full" style="width: ${(a/total)*100}%"></div></div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1"><span>Risk</span><span>${r.toFixed(1)}%</span></div>
                <div class="w-full h-2 bg-white/10 rounded-full"><div class="h-full bg-orange-500 rounded-full" style="width: ${(r/total)*100}%"></div></div>
            </div>
        `;

        // 5. Open Modal
        document.getElementById('result-modal').classList.remove('hidden');

        // Reset Button
        btn.innerHTML = `<i data-lucide="scan-search"></i> Compare & Predict`;
        lucide.createIcons();
    }

    lucide.createIcons();
</script>
</body>
</html>