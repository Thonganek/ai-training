<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Architect By TON Pro: Hybrid AI Suite v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define Themes */
        body[data-theme="midnight"] {
            --bg-main: #0f172a;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --text-heading: #f8fafc;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --border-color: rgba(255, 255, 255, 0.1);
            --code-bg: #020617;
            --console-bg: #050505;
            --nav-bg: rgba(15, 23, 42, 0.9);
            --slider-bg: #334155;
            --bg-gradient: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 20%),
                           radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
        }

        body[data-theme="matrix"] {
            --bg-main: #000000;
            --bg-panel: rgba(0, 20, 0, 0.8);
            --text-main: #22c55e;
            --text-muted: #15803d;
            --text-heading: #4ade80;
            --accent-primary: #22c55e;
            --accent-secondary: #16a34a;
            --border-color: rgba(34, 197, 94, 0.3);
            --code-bg: #020602;
            --console-bg: #000000;
            --nav-bg: rgba(0, 10, 0, 0.95);
            --slider-bg: #14532d;
            --bg-gradient: radial-gradient(circle at 50% 50%, rgba(34, 197, 94, 0.05) 0%, transparent 50%);
        }

        body[data-theme="lab"] {
            --bg-main: #f1f5f9;
            --bg-panel: rgba(255, 255, 255, 0.8);
            --text-main: #334155;
            --text-muted: #64748b;
            --text-heading: #0f172a;
            --accent-primary: #2563eb;
            --accent-secondary: #4f46e5;
            --border-color: rgba(0, 0, 0, 0.1);
            --code-bg: #ffffff;
            --console-bg: #e2e8f0;
            --nav-bg: rgba(255, 255, 255, 0.9);
            --slider-bg: #cbd5e1;
            --bg-gradient: radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.05) 0%, transparent 20%);
        }

        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            background-image: var(--bg-gradient);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* Dynamic Slider */
        .control-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--slider-bg);
            border-radius: 5px;
            outline: none;
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            transition: .2s;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .control-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; opacity: 0.5; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        .token-highlight { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Dynamic Text Colors */
        h1, h2, h3, h4 { color: var(--text-heading); }
        .text-slate-300 { color: var(--text-main) !important; }
        .text-slate-400 { color: var(--text-muted) !important; }
        
        /* Input overrides */
        input, textarea, select {
            color: var(--text-main) !important;
            background-color: var(--code-bg) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Navbar specific override */
        nav { background: var(--nav-bg) !important; }

        .editable-area:focus {
            outline: 2px solid var(--accent-primary);
            background: rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden selection:bg-blue-500 selection:text-white" data-theme="midnight">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 border-b border-[var(--border-color)] glass-panel transition-colors duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] rounded-lg shadow-lg">
                    <i data-lucide="network" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">LLM Architect <span class="text-xs align-top px-1.5 py-0.5 bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] rounded border border-[var(--accent-primary)]/30">PRO v3</span></h1>
                    <p class="text-xs text-[var(--text-muted)] font-mono">Hybrid AI Suite: Enhanced N-Gram + Cloud</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <!-- Back to Home Button -->
                <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-[var(--code-bg)] hover:bg-[var(--slider-bg)] border border-[var(--border-color)] rounded-lg text-xs font-bold transition-all text-[var(--text-muted)] hover:text-[var(--text-main)]">
                    <i data-lucide="home" class="w-4 h-4"></i> Back to Home
                </a>

                <!-- Theme Selector -->
                <div class="flex items-center gap-2 bg-[var(--code-bg)] rounded-lg px-2 py-1.5 border border-[var(--border-color)]">
                    <i data-lucide="palette" class="w-4 h-4 text-[var(--text-muted)]"></i>
                    <select onchange="setTheme(this.value)" id="theme-select" class="bg-transparent text-xs font-mono outline-none border-none cursor-pointer w-[120px] !p-0 !h-auto">
                        <option value="midnight">Midnight Pro</option>
                        <option value="matrix">Matrix Core</option>
                        <option value="lab">Clean Lab</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-6 max-w-[1800px]">
        <div class="grid grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: Configuration & Training -->
            <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                
                <!-- Model Selector (Enhanced) -->
                <div class="glass-panel rounded-xl p-4 border border-[var(--accent-primary)]/30">
                    <h2 class="text-xs font-bold mb-3 flex items-center gap-2 text-[var(--accent-primary)] uppercase tracking-wider">
                        <i data-lucide="cpu"></i> AI Core Selection
                    </h2>
                    <div class="flex gap-2 mb-3">
                        <button onclick="setMode('local')" id="mode-local" class="flex-1 py-2 rounded text-xs font-bold border border-[var(--accent-primary)] bg-[var(--accent-primary)] text-white transition-all">
                            Local N-Gram
                        </button>
                        <button onclick="setMode('cloud')" id="mode-cloud" class="flex-1 py-2 rounded text-xs font-bold border border-[var(--border-color)] text-[var(--text-muted)] hover:bg-[var(--slider-bg)] transition-all">
                            Cloud Gemini
                        </button>
                        <button onclick="setMode('hybrid')" id="mode-hybrid" class="flex-1 py-2 rounded text-xs font-bold border border-[var(--border-color)] text-[var(--text-muted)] hover:bg-[var(--slider-bg)] transition-all">
                            Hybrid
                        </button>
                    </div>
                    
                    <div id="cloud-config" class="hidden space-y-2 mt-2 pt-2 border-t border-[var(--border-color)]">
                        <label class="text-[10px] text-[var(--text-muted)]">Select API Key Source:</label>
                        <select id="api-key-select" class="w-full text-xs p-2 rounded border border-[var(--border-color)] bg-[var(--code-bg)]">
                            <option value="AIzaSyDiqXPAnfMICeehtGSC6VwDJaH9HqTIa-E">Key 1 (AIza...TIa-E)</option>
                            <option value="AIzaSyAuGmhGGfVIgdcBS-bDPu06I_fQpIy2Sng">Key 2 (AIza...2Sng)</option>
                            <option value="AIzaSyAXn2RnKle5RdJsD74PHVQbQAcOkPffkb4">Key 3 (AIza...fkb4)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Ingestion (Enhanced with File Upload) -->
                <div id="local-training-panel" class="glass-panel rounded-xl p-6 flex flex-col min-h-[350px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-base font-bold flex items-center gap-2" style="color: var(--accent-primary)">
                            <i data-lucide="database"></i> Corpus Ingestion
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="showTokens()" id="btn-show-tokens" class="hidden text-[10px] px-2 py-1 rounded bg-[var(--slider-bg)] hover:bg-[var(--accent-primary)] hover:text-white transition-all">
                                <i data-lucide="list"></i> View Tokens
                            </button>
                            <label class="cursor-pointer text-[10px] px-2 py-1 rounded bg-[var(--slider-bg)] hover:bg-[var(--accent-primary)] hover:text-white transition-all">
                                <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload()" accept=".txt,.md">
                                <i data-lucide="upload"></i> Upload File
                            </label>
                            <span class="text-[10px] px-2 py-1 rounded bg-[var(--code-bg)] border border-[var(--border-color)] text-[var(--text-muted)] font-mono">UTF-8</span>
                        </div>
                    </div>
                    <textarea id="corpus-input" class="flex-1 w-full rounded-lg p-4 font-mono text-sm focus:border-[var(--accent-primary)] focus:ring-1 focus:ring-[var(--accent-primary)] outline-none resize-none transition-all leading-relaxed" 
                    placeholder="/* Paste text or upload file to train the Local AI... */&#10;AI will learn words from here to generate answers."></textarea>
                    
                    <!-- Recommendation Box -->
                    <div id="rec-box" class="hidden mt-2 p-3 rounded bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 text-xs">
                        <div class="font-bold mb-1 flex items-center gap-1" style="color: var(--accent-primary)">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> Auto-Tune Recommendation:
                        </div>
                        <p id="rec-text" class="text-[var(--text-muted)]">Analyze corpus to see suggestions.</p>
                    </div>

                    <div class="mt-4 flex gap-3">
                        <button onclick="trainModel()" id="btn-train" class="flex-1 py-3 bg-[var(--accent-primary)] hover:opacity-90 text-white rounded-lg text-sm font-bold shadow-lg transition-all flex justify-center items-center gap-2 group">
                            <i data-lucide="zap" class="group-hover:rotate-180 transition-transform duration-500"></i> Train Model
                        </button>
                        <button onclick="loadPresetData()" class="px-4 py-3 bg-[var(--slider-bg)] hover:opacity-80 text-[var(--text-heading)] rounded-lg text-xs font-mono transition-all">
                            Demo
                        </button>
                        <button onclick="saveModel()" class="px-4 py-3 bg-[var(--slider-bg)] hover:opacity-80 text-[var(--text-heading)] rounded-lg text-xs font-mono transition-all">
                            Save
                        </button>
                        <button onclick="loadModel()" class="px-4 py-3 bg-[var(--slider-bg)] hover:opacity-80 text-[var(--text-heading)] rounded-lg text-xs font-mono transition-all">
                            Load
                        </button>
                    </div>
                </div>

                <!-- Hyperparameters (Enhanced with Smoothing) -->
                <div id="local-params-panel" class="glass-panel rounded-xl p-6 flex-1 transition-all">
                    <h2 class="text-base font-bold mb-6 flex items-center gap-2" style="color: var(--accent-secondary)">
                        <i data-lucide="sliders"></i> Hyperparameters
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- N-Gram -->
                        <div class="space-y-2 pb-4 border-b border-[var(--border-color)]">
                            <div class="flex justify-between text-sm">
                                <span class="text-[var(--text-muted)]">N-Gram Context (N)</span>
                                <span id="val-ngram" class="font-mono" style="color: var(--accent-primary)">3</span>
                            </div>
                            <input type="range" id="param-ngram" min="2" max="6" value="3" class="control-slider" oninput="updateDisplay('val-ngram', this.value)">
                            <p class="text-[10px] text-[var(--text-muted)] mt-1">ขอบเขตการจำข้อมูลย้อนหลัง (History Window) ยิ่งมากประโยคยิ่งเชื่อมโยง</p>
                        </div>

                        <!-- Temperature -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-[var(--text-muted)]">Temperature (T)</span>
                                <span id="val-temp" class="font-mono" style="color: var(--accent-secondary)">1.0</span>
                            </div>
                            <input type="range" id="param-temp" min="0.1" max="2.0" step="0.1" value="1.0" class="control-slider" oninput="updateDisplay('val-temp', this.value)">
                            <p class="text-[10px] text-[var(--text-muted)] mt-1">ระดับความสร้างสรรค์ (ต่ำ = แม่นยำตามสูตร, สูง = สุ่มหลากหลาย)</p>
                        </div>

                        <!-- Top-K -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-[var(--text-muted)]">Top-K Sampling</span>
                                <span id="val-topk" class="font-mono text-green-500">5</span>
                            </div>
                            <input type="range" id="param-topk" min="1" max="50" value="5" class="control-slider" oninput="updateDisplay('val-topk', this.value)">
                            <p class="text-[10px] text-[var(--text-muted)] mt-1">ตัดตัวเลือกเหลือเฉพาะ K คำที่มีโอกาสสูงสุด (ลดคำมั่ว)</p>
                        </div>

                        <!-- Laplace Smoothing (New) -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-[var(--text-muted)]">Laplace Smoothing (α)</span>
                                <span id="val-laplace" class="font-mono text-purple-500">0.1</span>
                            </div>
                            <input type="range" id="param-laplace" min="0.01" max="1.0" step="0.01" value="0.1" class="control-slider" oninput="updateDisplay('val-laplace', this.value)">
                            <p class="text-[10px] text-[var(--text-muted)] mt-1">เพิ่มความน่าจะเป็นให้คำใหม่ (ป้องกัน Zero Probability, ทำให้ AI ฉลาดขึ้น)</p>
                        </div>

                        <!-- Max Tokens -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-[var(--text-muted)]">Max Tokens</span>
                                <span id="val-maxtokens" class="font-mono text-orange-400">500</span>
                            </div>
                            <input type="range" id="param-maxtokens" min="10" max="5000" step="10" value="500" class="control-slider" oninput="updateDisplay('val-maxtokens', this.value)">
                            <p class="text-[10px] text-[var(--text-muted)] mt-1">จำนวนคำสูงสุดที่จะสร้างต่อครั้ง (Max 5000)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Visualization & Inference -->
            <div class="col-span-12 lg:col-span-8 flex flex-col gap-6 h-full">
                
                <!-- Visualization Canvas (Enhanced with More Layers) -->
                <div class="glass-panel rounded-xl p-1 relative h-[300px] overflow-hidden group border border-[var(--border-color)]">
                    <div class="absolute top-4 left-4 z-10 space-y-2 pointer-events-none">
                        <div class="bg-[var(--bg-main)]/80 backdrop-blur border border-[var(--border-color)] px-3 py-1.5 rounded-full flex items-center gap-2 w-fit">
                            <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-500"></div>
                            <span id="status-text" class="text-xs font-mono text-[var(--text-muted)]">System Idle</span>
                        </div>
                        <div class="bg-[var(--bg-main)]/80 backdrop-blur border border-[var(--border-color)] px-3 py-1.5 rounded-lg w-fit hidden" id="vocab-stat">
                            <span class="text-[10px] font-mono text-[var(--text-muted)] block">VOCAB SIZE</span>
                            <span class="text-lg font-mono text-[var(--text-heading)]" id="vocab-count">0</span>
                        </div>
                    </div>
                    <canvas id="nn-canvas" class="w-full h-full object-cover bg-[var(--console-bg)] rounded-lg"></canvas>
                </div>

                <!-- Inference Output (Enhanced with Copy Button) -->
                <div class="glass-panel rounded-xl p-0 flex flex-col flex-1 min-h-[450px] overflow-hidden border-t-4 border-t-[var(--accent-primary)] relative">
                    <div class="p-4 border-b border-[var(--border-color)] flex flex-wrap justify-between items-center bg-[var(--bg-panel)] gap-3">
                        <div class="flex items-center gap-2 flex-1 min-w-[200px]">
                            <i data-lucide="terminal-square" class="text-[var(--accent-primary)]"></i>
                            <input type="text" id="seed-input" class="flex-1 rounded px-3 py-2 text-sm font-mono transition-all focus:border-[var(--accent-primary)] outline-none" placeholder="Enter prompt...">
                        </div>
                        
                        <div class="flex items-center gap-2">
                             <!-- Length Selector -->
                             <select id="response-length" class="text-xs p-2 rounded border border-[var(--border-color)] bg-[var(--code-bg)] text-[var(--text-muted)] outline-none">
                                <option value="short">Short</option>
                                <option value="medium" selected>Medium</option>
                                <option value="long">Max</option>
                             </select>

                             <button onclick="generate()" class="bg-[var(--accent-primary)] hover:opacity-90 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                                <i data-lucide="play"></i> <span class="hidden sm:inline">Generate</span>
                             </button>
                             <button onclick="clearOutput()" class="bg-[var(--slider-bg)] hover:opacity-80 text-[var(--text-heading)] px-3 py-2 rounded text-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                             </button>
                             <button onclick="copyOutput()" class="bg-[var(--slider-bg)] hover:opacity-80 text-[var(--text-heading)] px-3 py-2 rounded text-sm">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                             </button>
                        </div>
                    </div>
                    
                    <!-- Output Area (Editable) -->
                    <div id="output-wrapper" class="relative flex-1 bg-[var(--console-bg)]">
                        <div id="output-console" contenteditable="true" class="w-full h-full p-6 font-mono text-base leading-7 text-[var(--text-main)] overflow-y-auto font-light border-none outline-none break-words whitespace-pre-wrap editable-area" 
                             oninput="handleEdit()">
                            <div class="opacity-50 select-none pointer-events-none">// Output tokens will stream here...</div>
                            <div class="opacity-50 select-none pointer-events-none">// You can edit the text after generation to teach the AI.</div>
                        </div>

                        <!-- Teaching Overlay -->
                        <div id="teach-overlay" class="absolute bottom-4 right-4 hidden transition-all">
                             <button onclick="teachAI()" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-full shadow-lg text-xs font-bold animate-bounce">
                                <i data-lucide="graduation-cap"></i> Teach AI (Update Model)
                             </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- TECHNICAL EXPLANATION SECTION (Updated) -->
        <div class="mt-8 glass-panel rounded-xl p-8 border border-[var(--border-color)]">
            <h3 class="text-xl font-bold mb-6 pb-2 border-b border-[var(--border-color)] flex items-center gap-3">
                <i data-lucide="book-open"></i> สถาปัตยกรรมทางเทคนิค (Technical Architecture)
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm leading-relaxed text-[var(--text-muted)]">
                <div class="space-y-4">
                    <h4 class="font-bold text-[var(--accent-primary)] text-base">1. ขั้นตอนการฝึกฝน (Enhanced Training)</h4>
                    <p>ระบบ N-Gram แบบอัปเกรด (Variable-Length N-Gram with Laplace Smoothing) เรียนรู้ทุกบริบทตั้งแต่ 1 คำ ถึง N คำ เพื่อความยืดหยุ่นสูงสุด:</p>
                    <ul class="list-disc pl-4 space-y-2 opacity-80">
                        <li><strong>Dynamic Tokenization:</strong> เก็บข้อมูลทุกระดับความลึก (Unigrams, Bigrams, Trigrams...)</li>
                        <li><strong>Markov Assumption:</strong> หลักการที่ว่า "คำถัดไป" ขึ้นอยู่กับ "ประวัติคำก่อนหน้า"</li>
                        <li><strong>Robust Storage:</strong> จัดเก็บโครงสร้างความน่าจะเป็นที่ครอบคลุมทุกรูปแบบประโยคที่เคยเห็น</li>
                        <li><strong>New: Laplace Smoothing:</strong> เพิ่ม alpha เพื่อจัดการ Zero Probability ทำให้ AI ฉลาดและไม่ตันง่าย</li>
                    </ul>
                </div>

                <div class="space-y-4">
                    <h4 class="font-bold text-[var(--accent-secondary)] text-base">2. ตรรกะอัจฉริยะ (Smart Backoff Logic)</h4>
                    <p>เพิ่มความฉลาดในการตอบโต้ด้วยเทคนิค Backoff & Smoothing:</p>
                    <div class="bg-[var(--code-bg)] p-3 rounded border border-[var(--border-color)] font-mono text-xs opacity-90">
                        If Context(N) not found -> Try Context(N-1) -> ... -> Smoothed Fallback
                    </div>
                    <ul class="list-disc pl-4 space-y-2 opacity-80">
                        <li><strong>Backoff Strategy:</strong> หากไม่เจอรูปแบบยาว (3 คำ) จะถอยมาดูรูปแบบสั้น (2 คำ หรือ 1 คำ) ทำให้ AI ไม่ "ตัน" ง่ายๆ</li>
                        <li><strong>Adaptive Temperature:</strong> ปรับความน่าจะเป็นตามค่า Slider เพื่อควบคุมความคิดสร้างสรรค์</li>
                        <li><strong>New: Hybrid Mode:</strong> ผสม Local N-Gram กับ Cloud เพื่อผลลัพธ์ที่ดีที่สุด</li>
                    </ul>
                </div>

                <div class="space-y-4">
                    <h4 class="font-bold text-orange-400 text-base">3. การแสดงผลเชิงภาพ (Visualization)</h4>
                    <p>การจำลองการทำงานของการส่งสัญญาณประสาท (Neural Signal Propagation):</p>
                    <ul class="list-disc pl-4 space-y-2 opacity-80">
                        <li><strong>Nodes (โหนด):</strong> ตัวแทนจำลองของกลุ่มเซลล์ประสาท (Neuron Clusters) ในแต่ละชั้น (Layer)</li>
                        <li><strong>Signals (สัญญาณ):</strong> ภาพเคลื่อนไหวที่แสดงถึงข้อมูลที่กำลังไหลผ่านเครือข่าย (Forward Pass)</li>
                        <li><strong>New: More Layers:</strong> เพิ่มชั้น layer เพื่อจำลอง Deep Network ทำให้ visualization สมจริงขึ้น</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Token Modal -->
        <div id="token-modal" class="fixed inset-0 z-[60] hidden bg-black/80 backdrop-blur-sm flex justify-center items-center p-4">
            <div class="bg-[var(--bg-main)] border border-[var(--border-color)] rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
                <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                    <h3 class="font-bold text-[var(--accent-primary)]">Vocabulary List (Tokens)</h3>
                    <button onclick="hideTokens()" class="text-[var(--text-muted)] hover:text-white"><i data-lucide="x"></i></button>
                </div>
                <div id="token-list" class="p-4 overflow-y-auto grid grid-cols-2 md:grid-cols-4 gap-2 font-mono text-xs text-[var(--text-muted)]">
                    <!-- Tokens injected here -->
                </div>
            </div>
        </div>

    </main>

<script>
    // --- 1. GLOBALS & UTILITIES ---
    const $ = id => document.getElementById(id);
    const updateDisplay = (id, val) => $(id).innerText = val;
    
    let isTraining = false;
    let currentMode = 'local'; // 'local', 'cloud', 'hybrid'
    let nodes = [], connections = [], signals = [];
    let animationId;
    let engine; 
    let canvas, ctx;

    // --- 2. ENGINE CLASS (Enhanced with Laplace Smoothing & Hybrid) ---
    class AdvancedNGramEngine {
        constructor() {
            this.ngrams = new Map();
            this.vocab = new Set();
            this.isTrained = false;
        }

        preprocess(text) {
            // Enhanced preprocessing: Better Thai support & punctuation
            return text.replace(/([.,!?;:()])/g, ' $1 ')
                       .replace(/\s+/g, ' ')
                       .trim()
                       .split(' ')
                       .filter(t => t.length > 0);
        }

        train(text, n, append = false) {
            if (!append) {
                this.ngrams.clear();
                this.vocab.clear();
            }
            const tokens = this.preprocess(text);
            tokens.forEach(t => this.vocab.add(t));

            // INTELLIGENT TRAINING: Learn ALL contexts from size 1 up to N
            for (let i = 0; i < tokens.length - 1; i++) {
                const nextWord = tokens[i + 1];
                for (let k = 1; k <= n; k++) {
                    if (i - k + 1 < 0) continue;
                    const context = tokens.slice(i - k + 1, i + 1).join(' ');
                    if (!this.ngrams.has(context)) {
                        this.ngrams.set(context, {});
                    }
                    const dist = this.ngrams.get(context);
                    dist[nextWord] = (dist[nextWord] || 0) + 1;
                }
            }

            this.isTrained = true;
            return { vocabSize: this.vocab.size, tokenCount: tokens.length };
        }

        predict(contextTokens, n, temp, topK, alpha) {
            let candidates = null;

            // SMART BACKOFF
            for (let currentN = n; currentN >= 1; currentN--) {
                const len = currentN;
                if (contextTokens.length < len) continue;
                const usedContext = contextTokens.slice(contextTokens.length - len).join(' ');
                if (this.ngrams.has(usedContext)) {
                    candidates = this.ngrams.get(usedContext);
                    break;
                }
            }

            // Fallback with Laplace Smoothing
            if (!candidates || Object.keys(candidates).length === 0) {
                const vocabArray = Array.from(this.vocab);
                if (vocabArray.length === 0) return null;
                // Uniform distribution with smoothing
                const smoothedProb = 1 / vocabArray.length;
                const items = vocabArray.map(word => ({ word, prob: smoothedProb }));
                let r = Math.random();
                for (let item of items) {
                    r -= item.prob;
                    if (r <= 0) return item.word;
                }
                return vocabArray[0];
            }

            // Apply Laplace Smoothing to candidates
            const V = this.vocab.size;
            const totalCounts = Object.values(candidates).reduce((sum, c) => sum + c, 0);
            let items = Object.entries(candidates).map(([word, count]) => ({
                word,
                score: (count + alpha) / (totalCounts + alpha * V)
            }));

            // Temperature
            items = items.map(item => ({
                ...item,
                prob: Math.pow(item.score, 1 / temp)
            }));

            // Normalize
            const sumProb = items.reduce((sum, item) => sum + item.prob, 0);
            items.forEach(item => item.prob /= sumProb);

            // Sort & Top-K
            items.sort((a, b) => b.prob - a.prob);
            if (topK > 0 && items.length > topK) {
                items = items.slice(0, topK);
            }

            // Weighted Random
            let r = Math.random();
            for (let item of items) {
                r -= item.prob;
                if (r <= 0) return item.word;
            }
            return items[0].word;
        }
    }

    // --- 3. UI LOGIC & MODES ---

    function setMode(mode) {
        currentMode = mode;
        const localBtn = $('mode-local');
        const cloudBtn = $('mode-cloud');
        const hybridBtn = $('mode-hybrid');
        const cloudConfig = $('cloud-config');
        const localPanel = $('local-training-panel');
        const localParams = $('local-params-panel');

        const style = getComputedStyle(document.body);
        const accent = style.getPropertyValue('--accent-primary').trim();
        const border = style.getPropertyValue('--border-color').trim();

        [localBtn, cloudBtn, hybridBtn].forEach(btn => {
            btn.style.backgroundColor = 'transparent';
            btn.style.color = 'var(--text-muted)';
            btn.style.borderColor = border;
        });

        if (mode === 'local') {
            localBtn.style.backgroundColor = accent;
            localBtn.style.color = '#fff';
            localBtn.style.borderColor = accent;
            cloudConfig.classList.add('hidden');
            localPanel.classList.remove('opacity-50', 'pointer-events-none');
        } else if (mode === 'cloud') {
            cloudBtn.style.backgroundColor = accent;
            cloudBtn.style.color = '#fff';
            cloudBtn.style.borderColor = accent;
            cloudConfig.classList.remove('hidden');
            localPanel.classList.add('opacity-50', 'pointer-events-none');
        } else { // hybrid
            hybridBtn.style.backgroundColor = accent;
            hybridBtn.style.color = '#fff';
            hybridBtn.style.borderColor = accent;
            cloudConfig.classList.remove('hidden');
            localPanel.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    function handleEdit() {
        $('teach-overlay').classList.remove('hidden');
    }

    function teachAI() {
        const newText = $('output-console').innerText;
        const n = parseInt($('param-ngram').value);
        
        const stats = engine.train(newText, n, true);
        
        $('teach-overlay').classList.add('hidden');
        
        const statusText = $('status-text');
        statusText.innerText = `Learned! Vocab: ${stats.vocabSize}`;
        statusText.style.color = '#22c55e';
        setTimeout(() => { statusText.style.color = 'var(--text-muted)'; statusText.innerText = "System Idle"; }, 2000);
        
        for(let i=0; i<5; i++) setTimeout(triggerSignal, i * 100);
        
        updateRecs(stats.vocabSize);
        $('vocab-count').innerText = stats.vocabSize;
    }

    function showTokens() {
        const list = $('token-list');
        list.innerHTML = '';
        const sortedVocab = Array.from(engine.vocab).sort();
        sortedVocab.forEach(word => {
            const div = document.createElement('div');
            div.className = 'p-1 bg-[var(--code-bg)] border border-[var(--border-color)] rounded';
            div.innerText = word;
            list.appendChild(div);
        });
        $('token-modal').classList.remove('hidden');
    }

    function hideTokens() {
        $('token-modal').classList.add('hidden');
    }

    function updateRecs(size) {
        const box = $('rec-box');
        const txt = $('rec-text');
        box.classList.remove('hidden');
        
        let recN = 3;
        let recTemp = 1.0;
        
        if (size < 100) {
            recN = 2; recTemp = 0.7;
            txt.innerText = `Small Corpus (${size} words). Recommending N=2, Temp=0.7 for stability.`;
        } else if (size > 1000) {
            recN = 5; recTemp = 1.3;
            txt.innerText = `Large Corpus (${size} words). Recommending N=5, Temp=1.3 for creativity.`;
        } else {
            txt.innerText = `Medium Corpus (${size} words). Recommending N=3, Temp=1.0 (Balanced).`;
        }
    }

    function handleFileUpload() {
        const file = $('file-upload').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            $('corpus-input').value += e.target.result;
        };
        reader.readAsText(file);
    }

    function saveModel() {
        if (!engine.isTrained) return alert("Train model first.");
        const data = {
            ngrams: Array.from(engine.ngrams.entries()),
            vocab: Array.from(engine.vocab)
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ngram_model.json';
        a.click();
    }

    function loadModel() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                engine.ngrams = new Map(data.ngrams);
                engine.vocab = new Set(data.vocab);
                engine.isTrained = true;
                $('vocab-count').innerText = engine.vocab.size;
                $('vocab-stat').classList.remove('hidden');
                $('btn-show-tokens').classList.remove('hidden');
                updateRecs(engine.vocab.size);
                alert("Model loaded successfully!");
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function copyOutput() {
        const text = $('output-console').innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("Output copied to clipboard!");
        });
    }

    // --- 4. CORE FUNCTIONS ---

    function loadPresetData() {
        const demoText = `Artificial intelligence (AI) is intelligence demonstrated by machines, as opposed to the natural intelligence displayed by humans or animals. Leading AI textbooks define the field as the study of "intelligent agents": any system that perceives its environment and takes actions that maximize its chance of achieving its goals. Some popular accounts use the term "artificial intelligence" to describe machines that mimic "cognitive" functions that humans associate with the human mind, such as "learning" and "problem solving". As machines become increasingly capable, tasks considered to require "intelligence" are often removed from the definition of AI, a phenomenon known as the AI effect.`;
        $('corpus-input').value = demoText;
    }

    function trainModel() {
        if (currentMode === 'cloud') return alert("Switch to Local or Hybrid Mode to train.");

        const text = $('corpus-input').value;
        if (!text.trim()) {
            alert("Error: Corpus is empty.");
            return;
        }

        const btn = $('btn-train');
        btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> Learning...`;
        
        setTimeout(() => {
            const ngramN = parseInt($('param-ngram').value);
            const stats = engine.train(text, ngramN);
            
            isTraining = false;
            btn.innerHTML = `<i data-lucide="check-circle-2"></i> Trained`;
            
            $('vocab-stat').classList.remove('hidden');
            $('vocab-count').innerText = stats.vocabSize;
            $('btn-show-tokens').classList.remove('hidden');
            
            updateRecs(stats.vocabSize);
            lucide.createIcons();
            for(let i=0; i<10; i++) setTimeout(triggerSignal, i * 100);

        }, 500);
    }

    async function generate() {
        const seed = $('seed-input').value.trim();
        const outputConsole = $('output-console');
        const style = getComputedStyle(document.body);
        const accentColor = style.getPropertyValue('--accent-primary').trim();
        const textColor = style.getPropertyValue('--text-main').trim();

        // --- INTELLIGENCE CONFIG ---
        let maxTokens = parseInt($('param-maxtokens').value);
        const temp = parseFloat($('param-temp').value);
        const topK = parseInt($('param-topk').value);
        const n = parseInt($('param-ngram').value);
        const alpha = parseFloat($('param-laplace').value);

        $('teach-overlay').classList.add('hidden');

        if (!seed) return alert("Please enter a prompt.");

        outputConsole.innerHTML = `<span style="color: ${accentColor}; font-weight: bold;">${seed}</span>`;

        if (currentMode === 'local' || currentMode === 'hybrid') {
            if (!engine.isTrained) {
                alert("Please train the Local Model first.");
                return;
            }
            let currentTokens = engine.preprocess(seed);
            if (currentTokens.length === 0) {
                const randomStart = Array.from(engine.vocab)[Math.floor(Math.random() * engine.vocab.size)];
                currentTokens = [randomStart];
                outputConsole.innerHTML = `<span style="color: ${accentColor}; font-weight: bold;">${randomStart}</span>`;
            }

            $('status-dot').style.backgroundColor = accentColor;
            $('status-text').innerText = "Local Inference...";

            for (let i = 0; i < maxTokens; i++) {
                await new Promise(r => setTimeout(r, 5)); // Faster for long gens
                const nextWord = engine.predict(currentTokens, n, temp, topK, alpha);
                if (!nextWord) break;
                triggerSignal();
                const span = document.createElement('span');
                span.className = "token-highlight ml-1";
                span.style.color = textColor;
                span.innerText = nextWord;
                outputConsole.appendChild(span);
                outputConsole.scrollTop = outputConsole.scrollHeight;
                currentTokens.push(nextWord);
            }

            $('status-dot').style.backgroundColor = '#22c55e';
            $('status-text').innerText = "Local Complete.";
            if (currentMode === 'local') return;
        }

        // Cloud or Hybrid continuation
        if (currentMode === 'cloud' || currentMode === 'hybrid') {
            const apiKey = $('api-key-select').value;
            outputConsole.innerHTML += `<br><span style="color:${accentColor}">Connecting to Gemini...</span>`;
            $('status-text').innerText = "Cloud Inference...";
            triggerSignal();

            try {
                const prompt = currentMode === 'hybrid' ? outputConsole.innerText : seed;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { 
                            maxOutputTokens: maxTokens,
                            temperature: temp,
                            topK: topK
                        }
                    })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const reply = data.candidates[0].content.parts[0].text;
                outputConsole.innerHTML += marked.parse(reply);
                $('status-text').innerText = "Cloud Complete.";
                for(let i=0; i<5; i++) setTimeout(triggerSignal, i * 200);

            } catch (e) {
                outputConsole.innerHTML += `<br><span style="color:red">Error: ${e.message}</span>`;
            }
        }
    }

    function clearOutput() {
        $('output-console').innerHTML = `<div style="opacity:0.5; pointer-events:none">// Ready...</div>`;
        $('teach-overlay').classList.add('hidden');
    }

    // --- 5. VISUALIZATION & INIT ---
    function initNetwork() {
        if (!canvas) return;
        nodes = []; connections = [];
        const layers = [8, 12, 12, 12, 8]; // More layers for deeper viz
        const layerX = canvas.width / (layers.length + 1);
        const style = getComputedStyle(document.body);
        const accent = style.getPropertyValue('--accent-primary').trim();

        layers.forEach((nodeCount, lIndex) => {
            const layerY = canvas.height / (nodeCount + 1);
            for (let i = 0; i < nodeCount; i++) {
                nodes.push({ x: layerX * (lIndex + 1), y: layerY * (i + 1), layer: lIndex, active: 0 });
            }
        });
        nodes.forEach(n1 => {
            nodes.forEach(n2 => {
                if (n2.layer === n1.layer + 1 && Math.random() > 0.3) connections.push({ from: n1, to: n2 });
            });
        });
    }

    function animate() {
        if (!ctx || !canvas) return;
        const style = getComputedStyle(document.body);
        const bg = style.getPropertyValue('--console-bg').trim();
        const accent = style.getPropertyValue('--accent-primary').trim();
        
        ctx.fillStyle = bg + '40'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 0.5;
        connections.forEach(c => {
            ctx.strokeStyle = c.from.active > 0.1 ? accent : style.getPropertyValue('--border-color');
            ctx.globalAlpha = 0.2 + c.from.active * 0.5;
            ctx.beginPath(); ctx.moveTo(c.from.x, c.from.y); ctx.lineTo(c.to.x, c.to.y); ctx.stroke();
            ctx.globalAlpha = 1.0;
        });

        nodes.forEach(n => {
            ctx.beginPath(); ctx.arc(n.x, n.y, 3 + n.active * 2, 0, Math.PI * 2);
            ctx.fillStyle = accent; ctx.globalAlpha = 0.3 + n.active; ctx.fill();
            if (n.active > 0) n.active *= 0.92;
            ctx.globalAlpha = 1.0;
        });

        for (let i = signals.length - 1; i >= 0; i--) {
            let s = signals[i]; s.progress += 0.08;
            const cx = s.from.x + (s.to.x - s.from.x) * s.progress;
            const cy = s.from.y + (s.to.y - s.from.y) * s.progress;
            ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2);
            ctx.fillStyle = style.getPropertyValue('--text-main');
            ctx.shadowBlur = 10; ctx.shadowColor = accent; ctx.fill(); ctx.shadowBlur = 0;
            if (s.progress >= 1) {
                s.to.active = 1.0;
                if (s.to.layer < layers.length - 1) {
                    const nextLinks = connections.filter(c => c.from === s.to);
                    if (nextLinks.length > 0) {
                        const nextLink = nextLinks[Math.floor(Math.random() * nextLinks.length)];
                        signals.push({ from: nextLink.from, to: nextLink.to, progress: 0 });
                    }
                }
                signals.splice(i, 1);
            }
        }
        animationId = requestAnimationFrame(animate);
    }

    function triggerSignal() {
        if (nodes.length === 0) return;
        const inputs = nodes.filter(n => n.layer === 0);
        const start = inputs[Math.floor(Math.random() * inputs.length)];
        start.active = 1;
        const nextLinks = connections.filter(c => c.from === start);
        if (nextLinks.length > 0) {
            const link = nextLinks[Math.floor(Math.random() * nextLinks.length)];
            signals.push({ from: link.from, to: link.to, progress: 0 });
        }
    }

    function resizeCanvas() {
        if (!canvas) return;
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        initNetwork();
    }

    function setTheme(themeName) {
        document.body.setAttribute('data-theme', themeName);
        localStorage.setItem('llm_theme', themeName);
        if ($('theme-select')) $('theme-select').value = themeName;
        if (canvas) initNetwork(); 
        setMode(currentMode);
    }

    window.addEventListener('load', () => {
        engine = new AdvancedNGramEngine();
        canvas = $('nn-canvas');
        ctx = canvas.getContext('2d');
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        setTheme(localStorage.getItem('llm_theme') || 'midnight');
        animate();
        lucide.createIcons();
    });
</script>
</body>
</html>